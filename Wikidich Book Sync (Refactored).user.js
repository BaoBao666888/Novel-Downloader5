// ==UserScript==
// @name         Wikidich Book Sync (Refactored)
// @namespace    https://github.com/BaoBao666888/
// @version      3.0.1
// @icon         data:image/x-icon;base64,AAABAAEAQEAAAAEAIAAoQgAAFgAAACgAAABAAAAAgAAAAAEAIAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAADaxiYA2sYmAdrGJnPaxibZ2sYm+9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJvzaxibf2sYmgNrGJgbaxiYA2sYmAtrGJpzaxib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiaw2sYmCNrGJm3axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJn/axibd2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axibl2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiT/2cUg/9jDG//Ywxr/2MMZ/9jDGf/Ywxr/2cQd/9rFIv/axiX/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJf/axSL/2cQd/9jDGv/Ywxn/2MMZ/9jDGf/Ywxv/2cQe/9rFI//axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cUi/9jDGv/Ywxr/28cp/+DORf/l12X/6dx6/+vgh//r4If/6Nt1/+PTVv/dyjT/2cQe/9jDGf/ZxB//2sYm/9rGJv/axib/2sYm/9rGJv/axiT/2cQd/9jDGf/ZxSD/3cs3/+PUWv/o3Hf/6+CH/+vgh//q3oH/5tls/+HRT//cyC7/2cQc/9jDGf/ZxSD/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxSD/2MMa/93LN//n2nL/8eqt//n23P/+/vr//////////////////////////////////Prs//Xvw//r4In/4M9G/9nEHf/ZxB3/2sYm/9rGJP/Ywxr/2sYm/+LTVf/t45L/9vHI//377v//////////////////////////////////////+/jk//PtuP/p3n//381B/9nEHP/ZxB7/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJf/Ywxj/3sw7/+/moP/9++7///////////////////////////////////////////////////////////////////////7++f/z7bf/4dFN/9jCF//axiX/6d16//j01f////////////////////////////////////////////////////////////////////////////799f/y67L/4M9I/9jDGP/axiT/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYn/9nFIf/ZxR//6d19//z77P/////////////////////////////////////////////////////////////////////////////////////////////++//w56T/9/LN//////////////////////////////////////////////////////////////////////////////////////////////////799v/s4Yr/2sYj/9nEH//axif/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYn/9nEH//byCz/8+yz//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////Xww//dyzj/2cQc/9rGJ//axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYn/9nEHv/cyS//9/LN//////////////////////////////////////////////////389P/7+OT/+PXX//n12P/8+un////9///////////////////////////////////////////////////////////////////////////////9//z66//59tz/+PTV//r33//8++7/////////////////////////////////////////////////+vji/+HQSf/Zwxv/2sYn/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nFIP/cyS//9/LN///////////////////////////////////////59tv/7eOS/+PUWv/ezDv/3Mgt/9rGJf/axib/3Mkx/+DQSf/p3Xr/9vHI//////////////////////////////////////////////////799f/z7LX/6Ntz/+DQSf/cyTL/28co/9rGJP/bxyr/3co1/+LSUP/r34X/9/PQ///////////////////////////////////////7+ej/385C/9nEHf/axif/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJP/ZxR//9O68//////////////////////////////////r44v/o23X/28co/9jCGP/ZxBz/2cUh/9rGI//axiX/2sYk/9rFI//ZxB//2MMY/9nFIP/k1V//9vLL/////////////////////////////v76/+/mnv/fzT//2MMb/9jDGf/ZxB//2sUj/9rGJP/axiX/2sYk/9rFIv/ZxB7/2MMY/9rFIv/l1mP/+fXX//////////////////////////////////n12P/byCv/2sUi/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxj/6t6B//////////////////////////////////Pstv/cyjL/2MMX/9rGJP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiX/2MMa/9rFIv/r4Ib//fvv////////////+fXY/+LSUf/Ywxf/2cUf/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiX/2MMZ/9vIKf/w6KX/////////////////////////////////8emr/9jDGv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxSD/380///788/////////////////////////////Hpqf/ZxB7/2cUg/9rGJ//axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axSH/2MMX//bwxf//////9e/A/9zJLf/Zwxv/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axSL/2MMa/+zhiv/////////////////////////////////m2Gf/2cQa/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMa//Hpqf////////////////////////////PstP/ZxB7/2sUi/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMZ/+3jkv//////9fDE/9rGJv/ZxR//2sYn/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJP/Ywxf/7uSW////////////////////////////+vfh/9vIKv/axiP/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sUh/97MO//+/fX///////////////////////r44f/cyS7/2cUg/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQc/+PTVf////7/+/jj/93KMv/ZxB7/2sYn/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYj/9nFHv/178H////////////////////////////p3Xv/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDGv/o3Hf////////////////////////////n2m//2MMY/9rGJ//axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYl/9rFIv/388///////+TWYP/Ywxn/2sYn/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/381A//388///////////////////////+PTS/9rFIv/axiX/2sYm/9rGJv/axib/2sYm/9rGJv/ZxBv/8+y2///////////////////////59tv/2sYm/9rGJP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axSP/2cUh/9rFIv/axiX/2sYm/9nEG//m12b///////Pstf/Ywxr/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sUj/9nFIf/ZxSL/2sYl/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDF//u5Zr//////////////////////////P/gz0j/2cUf/9rGJv/axib/2sYm/9rGJv/axiT/3Mgs//v45P//////////////////////7eKR/9jDGP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rFI//Ywxv/3Mkv/97MPv/dyzf/2cQf/9nEHv/ZxB3/9e/C///////h0U7/2cQd/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiP/2MMa/9zILv/ezD7/3cs4/9nEH//ZxB7/2sYn/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxSD/381A//799v//////////////////////6d5+/9jDGf/axib/2sYm/9rGJv/axib/2cQe/+HRTv////7//////////////////////+LSU//ZxB3/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rFIv/bxyj/7uSW//v45P/+/fb//fvv//Tuu//fzkL/3co0///++//38sv/2cQe/9rGJf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axSL/28cn/+3jlP/7+OP//v32//378P/07r3/4dBK/9nEHP/axif/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHf/28MX///////////////////////Lrs//ZxBv/2sYm/9rGJv/axib/2sYm/9jDGv/o23b///////////////////////z67P/cyjL/2sYj/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJf/axSD/8+23////////////////////////////+/nl/+3jk///////6t5+/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axiX/2cUg//PstP////////////////////////////377//gz0X/2cUf/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxj/7eKP///////////////////////59tz/28cn/9rGJP/axib/2sYm/9rGJv/Ywxn/7uSZ///////////////////////489D/2sUi/9rGJf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxBv/5tlr///////////////////////////////////////////////8/+HQSf/ZxR//2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQb/+bYaP//////////////////////////////////////9O69/9nEHf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bYaf///////////////////////fzz/97MOv/axSH/2sYm/9rGJv/axib/2MMb//LqsP//////////////////////9O26/9jDHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe//XwxP////////////////////////////////////////////v55v/cyC3/2sYj/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHf/177/////////////////////////////////////////+/P/gz0f/2cUf/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i01T///////////////////////7++//fzkT/2cUg/9rGJv/axib/2sYm/9nEHf/07r////////////////////////Dopv/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sUi/93LNv/9/PH////////////////////////////////////////////38s3/2sUh/9rGJf/axib/2sYm/9rGJv/axib/2sYm/9rFIv/dyjT//fvu////////////////////////////////////////////6dx5/9jDGv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56H/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lD/////////////////////////////////////////////////9O69/9nEHf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4dFO/////////////////////////////////////////////////+/mnf/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxBz/5ddl//////////////////////////////////////////////////Ptuf/ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQc/+XWY//////////////////////////////////////////////////z7LX/2cQb/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/07r///////////////////////+/nov/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bZa//////////////////////////////////////////////////z7bn/2MQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//n2Gn/////////////////////////////////////////////////9e68/9nEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56L/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m2Gr/////////////////////////////////////////////////8+25/9jEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5tdo//////////////////////////////////////////////////Ttu//ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5thq//////////////////////////////////////////////////Ptuf/YxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bXaP/////////////////////////////////////////////////07bv/2cQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/07r///////////////////////+/nov/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bYav/////////////////////////////////////////////////z7bn/2MQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m12j/////////////////////////////////////////////////9O27/9nEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56L/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m2Gr/////////////////////////////////////////////////8+25/9jEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5tdo//////////////////////////////////////////////////Ttu//ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5thq//////////////////////////////////////////////////Ptuf/YxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bXaP/////////////////////////////////////////////////07bv/2cQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/07r///////////////////////+/nov/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bYav/////////////////////////////////////////////////z7bn/2MQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m12j/////////////////////////////////////////////////9O27/9nEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56L/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m2Gr/////////////////////////////////////////////////8+25/9jEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5tdo//////////////////////////////////////////////////Ttu//ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5thq//////////////////////////////////////////////////Ptuf/YxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bXaP/////////////////////////////////////////////////07bv/2cQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/07r///////////////////////+/nov/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bYav/////////////////////////////////////////////////z7bn/2MQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m12j/////////////////////////////////////////////////9O27/9nEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56L/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m2Gr/////////////////////////////////////////////////8+25/9jEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5tdo//////////////////////////////////////////////////Ttu//ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5thq//////////////////////////////////////////////////Ptuf/YxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bXaP/////////////////////////////////////////////////07bv/2cQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9nEHv/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/07r///////////////////////+/nov/Ywxn/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2MMb/+bYav/////////////////////////////////////////////////z7bn/2MQc/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m12j/////////////////////////////////////////////////9O27/9nEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/ZxB7/4tJT///////////////////////+/vr/385D/9nFIP/axib/2sYm/9rGJv/ZxB3/9O6////////////////////////v56L/2MMZ/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9jDG//m2Gr/////////////////////////////////////////////////8+25/9jEHP/axib/2sYm/9rGJv/axib/2sYm/9rGJv/Ywxv/5tdo//////////////////////////////////////////////////Ttu//ZxBz/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cQe/+LSU////////////////////////v76/9/OQ//ZxSD/2sYm/9rGJv/axib/2cQd//Tuv///////////////////////7+ei/9jDGP/axiX/2sYl/9rGJf/axiX/2sYl/9rGJf/Ywxr/5thq//////////////////////////////////////////////////Ptuf/YxBv/2sYl/9rGJf/axiX/2sYl/9rGJf/axiX/2MMa/+bXaP/////////////////////////////////////////////////07bv/2cQb/9rGJf/axiX/2sYl/9rGJf/axiX/2sYl/9nEHf/i0lP///////////////////////7++v/fzkP/2cUg/9rGJv/axib/2sYm/9nEHf/078D//////////////////////+/mn//XwRL/2cQf/9nEH//ZxB//2cQf/9nEH//ZxB//18EU/+XXZv/////////////////////////////////////////////////z7bf/18IV/9nEH//ZxB//2cQf/9nEH//ZxB//2cQf/9fBFP/l1mP/////////////////////////////////////////////////9O25/9jCFf/ZxB//2cQf/9nEH//ZxB//2cQf/9nEH//Ywhf/4dFO///////////////////////+/vv/385E/9nFIP/axib/2sYm/9rGJv/ZxBz/8+25///////////////////////7+ej/9fDE//bxyP/28cj/9vHI//bxyP/28cj/9vHI//Xwxf/59dn//////////////////////////////////////////////////Pvt//Xwxf/28cj/9vHI//bxyP/28cj/9vHI//bxyP/18MX/+fXZ//////////////////////////////////////////////////z77v/28MX/9vHI//bxyP/28cj/9vHI//bxyP/28cj/9vDG//j00////////////////////////v73/9/NP//ZxSH/2sYm/9rGJv/axib/2MMZ/+zijf/////////////////////////////////////////////////////////////////////////////////////////////////+/ff//////////////////////////////////////////////////////////////////////////////////////////////////v33//////////////////////////////////////////////////////////////////////////////////////////////////n22//bxib/2sYk/9rGJv/axib/2sYm/9nEHv/i0U/////+////////////////////////////////////////////////////////////////////////////////////////////7eOT//z66////////////////////////////////////////////////////////////////////////////////////////////+7klv/7+eb////////////////////////////////////////////////////////////////////////////////////////////v5pz/2MMa/9rGJv/axib/2sYm/9rGJv/axib/2cQb/+3klf//////////////////////////////////////////////////////////////////////////////////////9fDD/9jDGf/p3Xz///////////////////////////////////////////////////////////////////////////////////////bxyP/ZxBv/6Nt1///////////////////////////////////////////////////////////////////////////////////////59tr/3Mkv/9rFIv/axib/2sYm/9rGJv/axib/2sYm/9rGJP/axSH/6+CJ//378P///////////////////////////////////////////////////////////////////vz/8uqu/9zILv/ZxSD/2cQd/+ncef/8+uz////////////////////////////////////////////////////////////////////9//Lqr//cyS//2cUg/9nEHf/o3Hj//Prr/////////////////////////////////////////////////////////////////////v/07rv/3sw5/9nEHv/axif/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYk/9jDG//ezDv/5thp/+3jkv/u5Jj/7uSY/+7kmP/u5Jj/7uSY/+7kmP/u5Jj/7uSY/+7kl//o3Hj/4M9I/9nEH//axSH/2sYn/9rGJf/Ywxv/3cs3/+XXZ//t45H/7uSY/+7kmP/u5Jj/7uSY/+7kmP/u5Jj/7uSY/+7kmP/u5Jf/6dx6/+DQSv/ZxB//2cUh/9rGJ//axiX/2MMb/93LNv/l12X/7eKQ/+7kmP/u5Jj/7uSY/+7kmP/u5Jj/7uSY/+7kmP/u5Jj/7uSY/+ndfP/h0Ez/2sUi/9nFH//axif/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2cUh/9jDG//Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMa/9nEH//axiX/2sYm/9rGJv/axib/2sYm/9rFIv/Ywxv/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGv/ZxB//2sYl/9rGJv/axib/2sYm/9rGJv/axSL/2cQc/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxn/2MMZ/9jDGf/Ywxr/2cQf/9rGJf/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv7axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv7axibW2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axibf2sYmX9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYmcdrGJgDaxiaH2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYmnNrGJgPaxiYA2sYmANrGJmHaxibR2sYm+trGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJv/axib/2sYm/9rGJvzaxibX2sYmb9rGJgDaxiYAgAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAwAAAAAAAAAM=
// @description  Syncs Wikidich chapters with a source (e.g., Fanqie, 69shuba) directly from the book page, handles hidden/empty content.
// @match        https://truyenwikidich.net/truyen/*
// @match        https://truyenwikidich.net/truyen/*/*/chinh-sua
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_deleteValue
// @grant        GM_addValueChangeListener
// @grant        GM_removeValueChangeListener
// @grant        GM_registerMenuCommand
// @grant        unsafeWindow
// @connect      *
// @run-at       document-idle
// ==/UserScript==

(async function () {
    'use strict';

    // --- Constants ---
    const DEBUG = true;
    const SCRIPT_ID = 'WikidichBookSync';
    const SCRIPT_VERSION = '3.0.1'; // Added version here
    const FANQIE_API_DEFAULT = 'https://rehaofan.jingluo.love';
    const NEXT_CHAPTER_DELAY = 2000;
    const TAB_CLOSE_DELAY_OK = 1000;
    const TAB_CLOSE_DELAY_SUBMIT = 2000;
    const TAB_CLOSE_DELAY_ERROR = 3000;
    const EDIT_PAGE_TIMEOUT = 60000;
    const MAX_CHAPTERS_TO_DISPLAY = 1000;

    // Storage Prefixes
    const STORAGE_PREFIX = `${SCRIPT_ID}_`;
    const WIKI_LIST_PREFIX = `${STORAGE_PREFIX}wiki_list_`;
    const SOURCE_LIST_PREFIX = `${STORAGE_PREFIX}source_list_`;
    const PROCESS_STATUS_PREFIX = `${STORAGE_PREFIX}process_status_`;
    const SOURCE_URL_PREFIX = `${STORAGE_PREFIX}source_url_`;
    const CURRENT_ADAPTER_PREFIX = `${STORAGE_PREFIX}adapter_`;
    const IS_RUNNING_PREFIX = `${STORAGE_PREFIX}running_`;
    const EDIT_TAB_STATUS_PREFIX = `${STORAGE_PREFIX}edit_status_`;

    // UI IDs
    const UI_PANEL_ID = `${SCRIPT_ID}-panel`;
    const UI_TOGGLE_ID = `${SCRIPT_ID}-toggle`;
    const UI_STATUS_ID = `${SCRIPT_ID}-status`;
    const UI_WIKI_LIST_ID = `${SCRIPT_ID}-wiki-list`;
    const UI_SOURCE_LIST_ID = `${SCRIPT_ID}-source-list`;
    const UI_SOURCE_URL_INPUT_ID = `${SCRIPT_ID}-source-url`;
    const UI_FETCH_SOURCE_BTN_ID = `${SCRIPT_ID}-fetch-source`;
    const UI_FETCH_WIKI_BTN_ID = `${SCRIPT_ID}-fetch-wiki`;
    const UI_RANGE_INPUT_ID = `${SCRIPT_ID}-range`;
    const UI_START_BTN_ID = `${SCRIPT_ID}-start`;
    const UI_STOP_BTN_ID = `${SCRIPT_ID}-stop`;
    const UI_CLEAR_HISTORY_BTN_ID = `${SCRIPT_ID}-clear`;
    const UI_CLOSE_BTN_ID = `${SCRIPT_ID}-close`;

    // --- Globals ---
    let FANQIE_API = FANQIE_API_DEFAULT;
    let currentBookInfo = null;
    let wikiChapters = [];
    let sourceChapters = [];
    let chapterStatus = {};
    let currentAdapter = null;
    let isSyncRunning = false;
    let syncQueue = [];
    let currentChapterProcessing = null;
    let editPageTimeoutId = null;
    let statusListenerId = null;

    // --- API Adapters ---
    const apiAdapters = {
        fanqie: {
            detect: (url) => /fanqienovel\.com\/(page|reader)\/\d+/.test(url),
            extractBookId: (url) => url.match(/fanqienovel\.com\/(?:page|reader)\/(\d+)/)?.[1],
            fetchDirectory: fetchFanqieDirectory,
            fetchContent: getChapterContentFromFanqie,
            name: "Fanqie Novel",
            requiresApi: true
        },
        shuba69: {
            detect: (url) => /69shu(?:ba)?\.(?:com|cx|net|org|pro|bar|ge|live|ink|me|cc|la|pt|io|art|id|shop|vip|click)\/(book\/\d+\/?(?:\.htm)?|txt\/\d+\/\d+)/.test(url),
            extractBookId: (url) => {
                const match = url.match(/69shu(?:ba)?\.[a-z0-9-]+\/(?:book|txt)\/(\d+)/); // More generic domain, match book or txt ID
                return match ? match[1] : null;
            },
            fetchDirectory: fetch69ShubaDirectory,
            fetchContent: getChapterContentFrom69Shuba,
            name: "69shu吧 (69shuba)",
            requiresApi: false
        },
    };

    // --- Source Fetching Functions for 69shuba ---
    async function fetch69ShubaDirectory(bookId, callback) {
        logToStatusUI('Đang tải danh sách chương 69shu吧...');
        const directoryUrl = `https://69shuba.cx/book/${bookId}/`; // .cx as a common one, can be parameterized
        logDebug(`Fetching 69shu吧 directory: ${directoryUrl}`);
        try {
            const doc = await WikiChapterFetcher.Http.get(directoryUrl, { overrideMimeType: 'text/html; charset=gbk' }).html();
            const chapterEls = doc.querySelectorAll('.mybox .catalog ul li a');
            if (!chapterEls || chapterEls.length === 0) {
                logToStatusUI('❌ Không tìm thấy chương nào trên 69shu吧.', true);
                callback(null); return;
            }
            let chapters = [];
            const reversedEls = Array.from(chapterEls).reverse();
            reversedEls.forEach((el) => {
                const name = el.textContent?.trim();
                const relativeHref = el.getAttribute('href');
                if (!name || !relativeHref) {
                    logDebug(`Skipping invalid chapter element on 69shu吧: name=${name}, href=${relativeHref}`);
                    return;
                }
                const absoluteUrl = new URL(relativeHref, directoryUrl).href;
                let number = null;
                const nameMatchDetailed = name.match(/^(?:第)?\s*(\d+)\s*(?:章|话|节|回|篇)/i);
                const nameMatchSimple = name.match(/^(\d+)/);
                if (nameMatchDetailed?.[1]) number = parseInt(nameMatchDetailed[1]);
                else if (nameMatchSimple?.[1]) number = parseInt(nameMatchSimple[1]);
                else logDebug(`Could not parse chapter number for 69shu吧: ${name}`);

                if (number !== null) { // Only add if number is parsed
                    chapters.push({ number, name, url: absoluteUrl, id: absoluteUrl });
                }
            });
            chapters = chapters.filter(c => c.id); // Ensure ID (url) exists
            chapters.sort((a, b) => a.number - b.number);
            if (chapters.length === 0) {
                logToStatusUI('⚠️ Không parse được chương 69shu吧 hợp lệ nào (thiếu số chương).', true);
                callback(null); return;
            }
            logToStatusUI(`✅ Tải xong ${chapters.length} chương từ 69shu吧.`);
            callback(chapters);
        } catch (error) {
            logDebug("Error fetching 69shu吧 directory:", error);
            logToStatusUI(`❌ Lỗi tải DS 69shu吧: ${error.message || error}`, true);
            callback(null);
        }
    }

    async function getChapterContentFrom69Shuba(chapterUrl, callback) {
        logDebug(`Fetching 69shu吧 content from ${chapterUrl}`);
        try {
            const doc = await WikiChapterFetcher.Http.get(chapterUrl, { overrideMimeType: 'text/html; charset=gbk' }).html();
            const contentElement = doc.querySelector('div.txtnav');
            if (!contentElement) {
                logDebug(`Content element 'div.txtnav' not found on ${chapterUrl}`);
                callback(null); return;
            }
            contentElement.querySelectorAll('script, style, iframe, .adsbygoogle, div[id*="ads"], div[class*="ads"], div[style*="text-align:center"], div:empty')
                .forEach(el => el.remove());
            const navigationDivs = Array.from(contentElement.querySelectorAll('div'));
            navigationDivs.forEach(div => {
                const text = div.textContent.toLowerCase();
                if (text.includes("上一章") || text.includes("下一章") || text.includes("目录") || text.includes("書籤") || text.includes("温馨提示") || text.includes("69书吧")) {
                    div.remove();
                }
            });
            // Remove potential title H1 if it's part of txtnav and unwanted
            // const h1Title = contentElement.querySelector('h1.hide720');
            // if (h1Title) h1Title.remove();

            const rawHtmlContent = contentElement.innerHTML;
            const textOnly = extractTextOnly(rawHtmlContent);
            if (!textOnly || textOnly.trim().length === 0) {
                logDebug(`Extracted empty content from ${chapterUrl} after processing.`);
                callback(null); return;
            }
            logDebug(`Successfully extracted text for 69shu吧 chapter. Length: ${textOnly.length}`);
            callback(textOnly);
        } catch (error) {
            logDebug(`Error fetching/processing 69shu吧 content from ${chapterUrl}:`, error);
            logToStatusUI(`❌ Lỗi tải nội dung 69shu吧 (${chapterUrl.slice(-20)}): ${error.message || error}`, true);
            callback(null);
        }
    }

    // --- Utility Functions ---
    function logDebug(...args) {
        if (DEBUG) console.log(`[${SCRIPT_ID}] ${getTimestamp()}:`, ...args);
    }
    function getTimestamp() { return new Date().toLocaleTimeString(); }
    function getStorageKey(prefix, bookKey) {
        if (!bookKey) { console.error("Cannot get storage key without bookKey"); return null; }
        const cleanKey = bookKey.replace(/[^a-zA-Z0-9_-]/g, '_');
        return `${prefix}${cleanKey}`;
    }
    async function saveToStorage(key, value) {
        if (!key) return;
        try {
            await GM_setValue(key, JSON.stringify(value));
            logDebug(`Saved to storage key: ${key}`);
        } catch (e) { console.error(`Error saving to storage key ${key}:`, e); logToStatusUI(`Lỗi lưu trữ: ${key}`, true); }
    }
    async function loadFromStorage(key, defaultValue = null) {
        if (!key) return defaultValue;
        const jsonValue = await GM_getValue(key, null);
        if (jsonValue === null) { logDebug(`Key '${key}' not found.`); return defaultValue; }
        try {
            return JSON.parse(jsonValue);
        } catch (e) {
            console.error(`[${SCRIPT_ID}] ERROR parsing JSON for key '${key}':`, e, "Raw JSON:", jsonValue);
            await GM_deleteValue(key); return defaultValue;
        }
    }
    function parseRange(rangeStr) {
        if (!rangeStr) return null;
        const [startStr, endStr] = rangeStr.trim().split('-');
        const start = parseInt(startStr);
        const end = (endStr && !isNaN(parseInt(endStr))) ? parseInt(endStr) : Infinity;
        return isNaN(start) ? null : { start, end };
    }
    async function initializeApiEndpoint() {
        const options = await getTokenOptionsWithRetry();
        if (options && options.Fanqie) {
            FANQIE_API = options.Fanqie;
            logDebug(`Using Fanqie API from tokenOptions: ${FANQIE_API}`);
        } else { logDebug(`Using default Fanqie API: ${FANQIE_API}`); }
    }
    async function getTokenOptionsWithRetry(timeoutMs = 3000, intervalMs = 200) {
        const startTime = Date.now();
        while (Date.now() - startTime < timeoutMs) {
            if (typeof unsafeWindow !== 'undefined' && unsafeWindow.tokenOptions) return unsafeWindow.tokenOptions;
            await new Promise(resolve => setTimeout(resolve, intervalMs));
        }
        logDebug(`Timeout waiting for unsafeWindow.tokenOptions.`); return null;
    }

    // --- Wikidich Chapter Fetching (Modified for GM_xmlhttpRequest options) ---
    const WikiChapterFetcher = {
        signFunc: `function signFunc(r){function o(r,o){return r>>>o|r<<32-o}for(var f,n,t=Math.pow,c=t(2,32),i="length",a="",e=[],u=8*r[i],v=[],g=[],h=g[i],l={},s=2;64>h;s++)if(!l[s]){for(f=0;313>f;f+=s)l[f]=s;v[h]=t(s,.5)*c|0,g[h++]=t(s,1/3)*c|0}for(r+="\u0080";r[i]%64-56;)r+="\0";for(f=0;f<r[i];f++){if((n=r.charCodeAt(f))>>8)return;e[f>>2]|=n<<(3-f)%4*8}for(e[e[i]]=u/c|0,e[e[i]]=u,n=0;n<e[i];){var d=e.slice(n,n+=16),p=v;for(v=v.slice(0,8),f=0;64>f;f++){var w=d[f-15],A=d[f-2],C=v[0],F=v[4],M=v[7]+(o(F,6)^o(F,11)^o(F,25))+(F&v[5]^~F&v[6])+g[f]+(d[f]=16>f?d[f]:d[f-16]+(o(w,7)^o(w,18)^w>>>3)+d[f-7]+(o(A,17)^o(A,19)^A>>>10)|0);(v=[M+((o(C,2)^o(C,13)^o(C,22))+(C&v[1]^C&v[2]^v[1]&v[2]))|0].concat(v))[4]=v[4]+M|0}for(f=0;8>f;f++)v[f]=v[f]+p[f]|0}for(f=0;8>f;f++)for(n=3;n+1;n--){var S=v[f]>>8*n&255;a+=(16>S?0:"")+S.toString(16)}return a}`,
        Script: { execute: (fnStr, fnName, arg) => new Function(fnStr + `; return ${fnName};`)()(arg) },
        Http: {
            get: (url, requestOptions = {}) => ({
                html: () => new Promise((resolve, reject) => {
                    GM_xmlhttpRequest({
                        method: "GET", url: url, ...requestOptions,
                        timeout: requestOptions.timeout || 20000,
                        onload: (res) => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(res.responseText, "text/html");
                            doc.html = () => res.responseText; resolve(doc);
                        },
                        onerror: (err) => { console.error(`[${SCRIPT_ID}] GM_xmlhttpRequest error for ${url}:`, err); reject(err); },
                        ontimeout: () => { console.error(`[${SCRIPT_ID}] GM_xmlhttpRequest timeout for ${url}.`); reject(new Error(`Request timed out for ${url}`)); }
                    });
                })
            })
        },
        Response: { success: (data) => data },
        getAllChapters: async function (url) { /* ... KEPT AS ORIGINAL ... */
            const BASE_URL = 'https://truyenwikidich.net';
            url = url.replace(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n?]+)/img, BASE_URL);
            let doc = await this.Http.get(url).html();
            const bookId = doc.querySelector("input#bookId")?.value;
            const html = doc.html();
            const size = html.match(/loadBookIndex.*?,\s*(\d+)/)?.[1] || 50;
            const signKey = html.match(/signKey\s*=\s*"(.*?)"/)?.[1];
            const fuzzySign = html.match(/function fuzzySign[\s\S]*?}/)?.[0];
            if (!bookId || !signKey || !fuzzySign) throw new Error("Thiếu dữ liệu cần thiết để tải chương Wiki.");
            const genSign = (sk, cp, sz) => this.Script.execute(this.signFunc, "signFunc", this.Script.execute(fuzzySign, "fuzzySign", sk + cp + sz));
            const getChapterInPage = async (cp) => {
                const params = new URLSearchParams({ bookId, signKey, sign: genSign(signKey, cp, size), size, start: cp.toFixed(0) });
                return await this.Http.get(`${BASE_URL}/book/index?${params}`).html();
            };
            let currentPage = 0; const data = []; doc = await getChapterInPage(currentPage);
            while (doc) {
                const els = doc.querySelectorAll("li.chapter-name a, ul#chapters li a, a[href*='/chuong-']");
                for (const e of els) {
                    let link = e.getAttribute("href") || e.getAttribute("data-href");
                    if (link?.length >= 2) {
                        const name = e.textContent.trim(); let number = null;
                        const nameMatch = name.match(/(?:Chương|第)\s*(\d+)/i);
                        const urlMatch = link.match(/\/chuong-(\d+)/i);
                        if (nameMatch?.[1]) number = parseInt(nameMatch[1]);
                        else if (urlMatch?.[1]) number = parseInt(urlMatch[1]);
                        if (number !== null) {
                            const absoluteUrl = link.startsWith('http') ? link : (link.startsWith('/') ? `${BASE_URL}${link}` : `${BASE_URL}/${link}`);
                            data.push({ number, name, url: absoluteUrl, host: BASE_URL });
                        } else logDebug(`Could not parse Wiki chapter number: ${name} (${link})`);
                    }
                }
                const paginationLinks = doc.querySelectorAll("ul.pagination a[data-start]");
                const lastPage = paginationLinks.length > 0 ? parseInt(paginationLinks[paginationLinks.length - 1].getAttribute("data-start")) : 0;
                if (currentPage >= lastPage) break;
                currentPage += parseInt(size); doc = await getChapterInPage(currentPage);
            }
            return this.Response.success(data);
        }
    };

    // --- Source Fetching Functions (Fanqie) ---
    async function fetchFanqieDirectory(bookId, callback) { /* ... KEPT AS ORIGINAL ... */
        logToStatusUI('Đang tải danh sách chương Fanqie...');
        const directoryUrl = `https://fanqienovel.com/page/${bookId}`;
        logDebug(`Fetching Fanqie directory: ${directoryUrl}`);
        try {
            const doc = await WikiChapterFetcher.Http.get(directoryUrl).html();
            const chapterEls = doc.querySelectorAll('.page-directory-content .chapter-item a.chapter-item-title');
            if (!chapterEls || chapterEls.length === 0) { logToStatusUI('❌ Không tìm thấy chương Fanqie.', true); callback(null); return; }
            const chapters = Array.from(chapterEls).map(el => {
                const name = el.innerText?.trim(); const href = el.getAttribute('href');
                const url = href ? new URL(href, 'https://fanqienovel.com/').href : null;
                const numberMatch = name?.match(/第\s*(\d+)\s*章/);
                const idMatch = href?.match(/reader\/(\d+)/);
                return { number: numberMatch ? parseInt(numberMatch[1]) : null, name: name || 'N/A', url, id: idMatch ? idMatch[1] : null };
            }).filter(c => c.number !== null && c.id && c.url);
            if (chapters.length === 0) { logToStatusUI('⚠️ Không parse được chương Fanqie hợp lệ.', true); callback(null); return; }
            chapters.sort((a, b) => a.number - b.number);
            logToStatusUI(`✅ Tải xong ${chapters.length} chương Fanqie.`);
            callback(chapters);
        } catch (error) { logDebug("Error fetching Fanqie directory:", error); logToStatusUI(`❌ Lỗi tải DS Fanqie: ${error.message}`, true); callback(null); }
    }
    async function getChapterContentFromFanqie(chapterId, callback) { /* ... KEPT AS ORIGINAL ... */
        const apiUrl = FANQIE_API.replace(/{chapter_id}/g, chapterId);
        logDebug(`Fetching Fanqie content ID ${chapterId} from ${apiUrl}`);
        GM_xmlhttpRequest({
            method: 'GET', url: apiUrl, responseType: 'json', timeout: 20000,
            onload: res => {
                if (res.status >= 200 && res.status < 300) {
                    try {
                        let contentData = res.response; const R = contentData;
                        let content = R.content || R.data?.content || R.data?.data?.content || R.chapter?.content || R.text;
                        if (!content && R.data?.[chapterId]?.content) content = R.data[chapterId].content;
                        if (!content && R[chapterId]?.content) content = R[chapterId].content;
                        if (typeof content === 'object' && content !== null && content.value) content = content.value;
                        if (typeof content === 'string') {
                            content = content.trim(); if (content.length === 0) { callback(null); return; }
                            const textOnly = extractTextOnly(content); callback(textOnly);
                        } else { callback(null); }
                    } catch (e) { logDebug(`Error processing Fanqie JSON ID ${chapterId}:`, e); callback(null); }
                } else { logDebug(`Fanqie API HTTP Error ${res.status} ID ${chapterId}.`); callback(null); }
            },
            onerror: error => { logDebug(`Network error Fanqie ID ${chapterId}:`, error); callback(null); },
            ontimeout: () => { logDebug(`Timeout Fanqie ID ${chapterId}.`); callback(null); }
        });
    }

    function extractTextOnly(html) {
        const decoded = html.replace(/\\u003C/g, '<').replace(/\\u003E/g, '>').replace(/\\u0026/g, '&').replace(/\\"/g, '"');
        const parser = new DOMParser(); const doc = parser.parseFromString(decoded, 'text/html');
        let walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
        let textSegments = [];
        while (walker.nextNode()) {
            let text = walker.currentNode.nodeValue.trim();
            if (text) textSegments.push(text);
            else if (textSegments.length > 0 && textSegments[textSegments.length - 1] !== '') textSegments.push('');
        }
        return textSegments.join('\n');
    }

    // --- UI Functions ---
    function addStyles() { GM_addStyle(`/* ... CSS styles from previous version ... */
        #${UI_PANEL_ID} { position: fixed; bottom: 10px; right: 10px; width: 600px; max-height: 75vh; background: #f9f9f9; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 9999; display: none; flex-direction: column; font-family: sans-serif; font-size: 13px; color: #333; }
        #${UI_PANEL_ID} .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #eee; border-bottom: 1px solid #ccc; border-radius: 8px 8px 0 0; }
        #${UI_PANEL_ID} .panel-header h4 { margin: 0; font-size: 16px; color: #1a73e8; font-weight: 600; }
        #${UI_PANEL_ID} .panel-controls { display: flex; gap: 5px; }
        #${UI_PANEL_ID} .panel-header button { background: none; border: none; font-size: 18px; cursor: pointer; padding: 0 4px; color: #777; line-height: 1; vertical-align: middle; }
        #${UI_PANEL_ID} .panel-header button#${UI_STOP_BTN_ID} { color: #f44336; font-size: 16px; }
        #${UI_PANEL_ID} .panel-header button#${UI_CLOSE_BTN_ID} { color: #aaa; font-size: 20px; }
        #${UI_PANEL_ID} .panel-header button:hover { color: #333; }
        #${UI_PANEL_ID} .panel-header button#${UI_STOP_BTN_ID}:hover { color: #c62828; }
        #${UI_PANEL_ID} .panel-body { padding: 10px; overflow: hidden; display: flex; flex-direction: column; flex-grow: 1; }
        #${UI_PANEL_ID} .config-section { display: grid; grid-template-columns: auto 1fr; gap: 8px; align-items: center; margin-bottom: 10px; }
        #${UI_PANEL_ID} label { font-weight: 500; }
        #${UI_PANEL_ID} input[type="url"], #${UI_PANEL_ID} input[type="text"] { padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #${UI_PANEL_ID} .config-section .button-group-container { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; justify-content: space-between; }
        #${UI_PANEL_ID} .config-section .button-group-container > div { display: flex; gap: 8px; }
        #${UI_PANEL_ID} button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; background-color: #e0e0e0; color: #333; transition: background-color 0.2s; }
        #${UI_PANEL_ID} button:hover:not(:disabled) { background-color: #d5d5d5; }
        #${UI_PANEL_ID} button:disabled { cursor: not-allowed; opacity: 0.6; }
        #${UI_PANEL_ID} button.primary { background-color: #1a73e8; color: white; }
        #${UI_PANEL_ID} button.primary:hover:not(:disabled) { background-color: #1565c0; }
        #${UI_PANEL_ID} button.start { background-color: #ff9800; color: white; }
        #${UI_PANEL_ID} button.start:hover:not(:disabled) { background-color: #f57c00; }
        #${UI_PANEL_ID} .list-section { display: flex; flex-grow: 1; gap: 10px; margin-top: 10px; overflow: hidden; }
        #${UI_PANEL_ID} .chapter-list-container { flex: 1; display: flex; flex-direction: column; border: 1px solid #ddd; background: #fff; border-radius: 4px; overflow: hidden;}
        #${UI_PANEL_ID} .list-header { padding: 5px 8px; background: #f5f5f5; font-weight: bold; border-bottom: 1px solid #ddd; white-space: nowrap; }
        #${UI_PANEL_ID} .chapter-list { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex-grow: 1; }
        #${UI_PANEL_ID} .chapter-list li { padding: 4px 8px; border-bottom: 1px solid #eee; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: default; }
        #${UI_PANEL_ID} .chapter-list li:last-child { border-bottom: none; }
        #${UI_PANEL_ID} .chapter-list li span.ch-num { display: inline-block; width: 35px; color: #666; margin-right: 5px; text-align: right;}
        #${UI_PANEL_ID} .chapter-list li.status-processing { background-color: #fffde7; font-weight: bold; }
        #${UI_PANEL_ID} .chapter-list li.status-checked_ok { color: #757575; }
        #${UI_PANEL_ID} .chapter-list li.status-submit_triggered { background-color: #e1f5fe; }
        #${UI_PANEL_ID} .chapter-list li.status-updated_hidden { background-color: #c8e6c9; }
        #${UI_PANEL_ID} .chapter-list li.status-error { background-color: #ffcdd2; color: #b71c1c; }
        #${UI_PANEL_ID} .chapter-list li.status-skipped { color: #bdbdbd; font-style: italic; }
        #${UI_PANEL_ID} .panel-footer { padding: 8px 12px; border-top: 1px solid #ccc; background: #eee; font-size: 12px; color: #555; border-radius: 0 0 8px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #${UI_TOGGLE_ID} { position: fixed; top: 150px; right: 0; background: #1a73e8; color: white; padding: 8px 5px; border: none; border-radius: 5px 0 0 5px; cursor: pointer; z-index: 9998; font-size: 18px; box-shadow: -2px 2px 5px rgba(0,0,0,0.2); line-height: 1; }
    `); }

    function createMainUI() {
        if (document.getElementById(UI_PANEL_ID)) return;
        const panel = document.createElement('div');
        panel.id = UI_PANEL_ID;
        panel.style.display = 'none'; // Default to hidden

        panel.innerHTML = `
            <div class="panel-header">
                <h4>⚙️ Đồng bộ Sách (v${SCRIPT_VERSION})</h4>
                <div class="panel-controls">
                    <button id="${UI_STOP_BTN_ID}" title="Dừng" disabled>⏹️</button>
                    <button id="${UI_CLOSE_BTN_ID}" title="Đóng Panel">×</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="config-section">
                    <label for="${UI_SOURCE_URL_INPUT_ID}">Link nguồn:</label>
                    <input type="url" id="${UI_SOURCE_URL_INPUT_ID}" placeholder="VD: https://fanqienovel.com/page/...">
                    <label for="${UI_RANGE_INPUT_ID}">Khoảng sync:</label>
                    <input type="text" id="${UI_RANGE_INPUT_ID}" placeholder="VD: 1-100 hoặc 50-">
                    <div class="button-group-container">
                        <div> <!-- Left group -->
                            <button id="${UI_FETCH_WIKI_BTN_ID}" class="primary" title="Tải DS chương từ Wikidich">Tải Wiki</button>
                            <button id="${UI_FETCH_SOURCE_BTN_ID}" class="primary" title="Tải DS chương từ link nguồn">Tải Nguồn</button>
                        </div>
                        <div> <!-- Right group -->
                            <button id="${UI_START_BTN_ID}" class="start" title="Bắt đầu đồng bộ" disabled>🚀 Bắt đầu</button>
                            <button id="${UI_CLEAR_HISTORY_BTN_ID}" title="Xóa lịch sử đồng bộ của sách này">🗑️ Xóa LS</button>
                        </div>
                    </div>
                </div>
                <div class="list-section">
                    <div class="chapter-list-container">
                        <div class="list-header">Wikidich (<span id="wiki-count">0</span>)</div>
                        <ul class="chapter-list" id="${UI_WIKI_LIST_ID}"><li><i>Chưa tải...</i></li></ul>
                    </div>
                    <div class="chapter-list-container">
                        <div class="list-header">Nguồn (<span id="source-name">Chưa xác định</span>: <span id="source-count">0</span>)</div>
                        <ul class="chapter-list" id="${UI_SOURCE_LIST_ID}"><li><i>Chưa tải...</i></li></ul>
                    </div>
                </div>
            </div>
            <div class="panel-footer" id="${UI_STATUS_ID}">Chờ thao tác...</div>
        `;
        document.body.appendChild(panel);

        document.getElementById(UI_CLOSE_BTN_ID)?.addEventListener('click', () => panel.style.display = 'none');
        document.getElementById(UI_FETCH_WIKI_BTN_ID)?.addEventListener('click', handleFetchWikiChapters);
        document.getElementById(UI_FETCH_SOURCE_BTN_ID)?.addEventListener('click', handleFetchSourceChapters);
        document.getElementById(UI_START_BTN_ID)?.addEventListener('click', handleStartSync);
        document.getElementById(UI_STOP_BTN_ID)?.addEventListener('click', handleStopSync);
        document.getElementById(UI_CLEAR_HISTORY_BTN_ID)?.addEventListener('click', handleClearHistory);

        loadFromStorage(getStorageKey(SOURCE_URL_PREFIX, currentBookInfo.key))
          .then(url => {
              if (url) {
                  const input = document.getElementById(UI_SOURCE_URL_INPUT_ID);
                  if (input) input.value = url;
                   detectAdapter(url); updateUI();
              }
          });
         loadFromStorage(getStorageKey(`${STORAGE_PREFIX}last_range_`, currentBookInfo.key))
           .then(range => {
               if (range) { const input = document.getElementById(UI_RANGE_INPUT_ID); if (input) input.value = range; }
           });
        return panel;
    }

    function updateUI() { /* ... KEPT AS ORIGINAL (with sourceNameSpan update) ... */
        const panel = document.getElementById(UI_PANEL_ID);
        if (!panel || panel.style.display === 'none') return;
        const startBtn = document.getElementById(UI_START_BTN_ID);
        const stopBtn = document.getElementById(UI_STOP_BTN_ID);
        const fetchWikiBtn = document.getElementById(UI_FETCH_WIKI_BTN_ID);
        const fetchSourceBtn = document.getElementById(UI_FETCH_SOURCE_BTN_ID);
        const clearBtn = document.getElementById(UI_CLEAR_HISTORY_BTN_ID);
        const rangeInput = document.getElementById(UI_RANGE_INPUT_ID);
        const sourceInput = document.getElementById(UI_SOURCE_URL_INPUT_ID);
        const sourceNameSpan = document.getElementById('source-name');

        if (startBtn) startBtn.disabled = isSyncRunning || !wikiChapters.length || !sourceChapters.length;
        if (stopBtn) stopBtn.disabled = !isSyncRunning;
        if (fetchWikiBtn) fetchWikiBtn.disabled = isSyncRunning;
        if (fetchSourceBtn) fetchSourceBtn.disabled = isSyncRunning;
        if (clearBtn) clearBtn.disabled = isSyncRunning;
        if (rangeInput) rangeInput.disabled = isSyncRunning;
        if (sourceInput) sourceInput.disabled = isSyncRunning;
        if (sourceNameSpan) sourceNameSpan.textContent = currentAdapter?.name || 'Chưa xác định';
        updateChapterListsUI();
    }
    function updateChapterListsUI() { /* ... KEPT AS ORIGINAL ... */
        const wikiListUl = document.getElementById(UI_WIKI_LIST_ID);
        const sourceListUl = document.getElementById(UI_SOURCE_LIST_ID);
        const wikiCountSpan = document.getElementById('wiki-count');
        const sourceCountSpan = document.getElementById('source-count');
        if (!wikiListUl || !sourceListUl || !wikiCountSpan || !sourceCountSpan) return;
        wikiCountSpan.textContent = wikiChapters.length;
        sourceCountSpan.textContent = sourceChapters.length;
        const renderList = (ul, chapters) => {
            ul.innerHTML = ''; const chaptersToRender = chapters; // Could be chapters.slice(0, MAX_CHAPTERS_TO_DISPLAY);
            chaptersToRender.forEach(chapter => {
                const li = document.createElement('li');
                const status = chapterStatus[chapter.number] || 'pending';
                li.className = `status-${status}`;
                li.title = `Chương ${chapter.number}: ${chapter.name} (${status})`;
                li.dataset.chapterNumber = chapter.number;
                const numSpan = document.createElement('span'); numSpan.className = 'ch-num'; numSpan.textContent = chapter.number;
                const nameSpan = document.createElement('span'); nameSpan.className = 'ch-name'; nameSpan.textContent = chapter.name;
                li.appendChild(numSpan); li.appendChild(nameSpan); ul.appendChild(li);
            });
            if (chapters.length === 0) ul.innerHTML = '<li><i>Danh sách trống</i></li>';
        };
        renderList(wikiListUl, wikiChapters);
        renderList(sourceListUl, sourceChapters);
        if (currentChapterProcessing) {
            const targetLi = wikiListUl.querySelector(`li[data-chapter-number="${currentChapterProcessing}"]`);
            if (targetLi) targetLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    function logToStatusUI(message, isError = false) { /* ... KEPT AS ORIGINAL ... */
        const statusDiv = document.getElementById(UI_STATUS_ID);
        if (statusDiv) {
            statusDiv.textContent = `[${getTimestamp()}] ${message}`;
            statusDiv.style.color = isError ? '#d32f2f' : '#333';
            statusDiv.style.fontWeight = isError ? 'bold' : 'normal';
        }
        if (DEBUG) { const prefix = isError ? 'ERROR:' : 'INFO:'; logDebug(prefix, message); }
    }
    function scrollToChapter(chapterNumber) { /* ... KEPT AS ORIGINAL ... */
         const wikiListUl = document.getElementById(UI_WIKI_LIST_ID);
         const sourceListUl = document.getElementById(UI_SOURCE_LIST_ID);
         const scrollToLi = (ul) => {
             if (!ul) return;
             const targetLi = ul.querySelector(`li[data-chapter-number="${chapterNumber}"]`);
             if (targetLi) targetLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
         };
         scrollToLi(wikiListUl); scrollToLi(sourceListUl);
     }

    // --- Core Logic Functions ---
    function getBookInfo() { /* ... KEPT AS ORIGINAL ... */
        const titleElement = document.querySelector('.cover-info h2');
        const title = titleElement?.textContent?.trim() || 'Unknown Book';
        let bookId = document.querySelector("input#bookId")?.value;
        if (!bookId) { const bookIdMatch = document.documentElement.innerHTML.match(/bookId['"]?\s*:\s*['"]?(\d+)['"]?/); bookId = bookIdMatch?.[1]; }
        if (!bookId) { logToStatusUI("Lỗi: Không tìm thấy ID sách Wikidich.", true); return null; }
        const key = `${title.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '_')}_${bookId}`;
        logDebug(`Book Info: Title='${title}', ID='${bookId}', Key='${key}'`);
        return { id: bookId, title: title, key: key };
    }
    function detectAdapter(url) { /* ... KEPT AS ORIGINAL (with adapter key saving logic) ... */
        if (!url) { currentAdapter = null; return null; }
        for (const key in apiAdapters) {
            const adapter = apiAdapters[key];
            if (adapter.detect(url)) {
                currentAdapter = adapter; logDebug(`Detected source adapter: ${adapter.name}`);
                saveToStorage(getStorageKey(CURRENT_ADAPTER_PREFIX, currentBookInfo.key), key); // Save adapter key (as string "shuba69", "fanqie")
                 if (adapter.requiresApi && FANQIE_API === FANQIE_API_DEFAULT) initializeApiEndpoint();
                return adapter;
            }
        }
        currentAdapter = null; logDebug(`No adapter found for URL: ${url}`);
        GM_deleteValue(getStorageKey(CURRENT_ADAPTER_PREFIX, currentBookInfo.key));
        return null;
    }
    function detectSourceLinkOnPage() { /* ... KEPT AS ORIGINAL ... */
        const links = document.querySelectorAll('.book-desc a, .tab-content a');
        for (const link of links) {
            const url = link.href;
            if (url) {
                for (const key in apiAdapters) {
                    if (apiAdapters[key].detect(url)) {
                        logDebug(`Auto-detected source link: ${url} (Adapter: ${apiAdapters[key].name})`);
                        const input = document.getElementById(UI_SOURCE_URL_INPUT_ID);
                        if (input) input.value = url; detectAdapter(url); return url;
                    }
                }
            }
        }
        logDebug("No known source link auto-detected."); return null;
    }
    async function loadPersistedData() { /* ... KEPT AS ORIGINAL (with JSON.parse for adapter key) ... */
        if (!currentBookInfo) return; logDebug("Loading persisted data...");
        const wikiKey = getStorageKey(WIKI_LIST_PREFIX, currentBookInfo.key);
        const sourceKey = getStorageKey(SOURCE_LIST_PREFIX, currentBookInfo.key);
        const statusKey = getStorageKey(PROCESS_STATUS_PREFIX, currentBookInfo.key);
        const adapterKey = getStorageKey(CURRENT_ADAPTER_PREFIX, currentBookInfo.key);

        wikiChapters = await loadFromStorage(wikiKey, []);
        sourceChapters = await loadFromStorage(sourceKey, []);
        chapterStatus = await loadFromStorage(statusKey, {});

        const savedAdapterKeyJSON = await GM_getValue(adapterKey, null); // This GM_getValue gets the JSON string "fanqie" or "shuba69"
        if (savedAdapterKeyJSON) {
            try {
                const parsedAdapterKey = JSON.parse(savedAdapterKeyJSON); // JSON.parse("\"fanqie\"") -> "fanqie"
                if (parsedAdapterKey && apiAdapters[parsedAdapterKey]) {
                    currentAdapter = apiAdapters[parsedAdapterKey];
                    logDebug(`Loaded adapter from storage: ${currentAdapter.name}`);
                    if (currentAdapter.requiresApi && FANQIE_API === FANQIE_API_DEFAULT) initializeApiEndpoint();
                } else { logDebug(`Invalid adapter key from storage: ${parsedAdapterKey}`); await GM_deleteValue(adapterKey); currentAdapter = null; }
            } catch (e) { logDebug("Error parsing saved adapter key JSON:", e); await GM_deleteValue(adapterKey); currentAdapter = null; }
        } else { currentAdapter = null; logDebug("No adapter key in storage."); }

        if (!currentAdapter) {
            logDebug("No valid adapter in storage. Trying auto-detection if URL exists.");
            const savedUrl = await loadFromStorage(getStorageKey(SOURCE_URL_PREFIX, currentBookInfo.key));
            if (savedUrl) detectAdapter(savedUrl);
        }
        logDebug(`Loaded ${wikiChapters.length} wiki, ${sourceChapters.length} source chapters, ${Object.keys(chapterStatus).length} statuses.`);
        wikiChapters.forEach(ch => { if (!(ch.number in chapterStatus)) chapterStatus[ch.number] = 'pending'; });
        updateUI();
    }
    async function saveChapterStatus() { /* ... KEPT AS ORIGINAL ... */
        if (!currentBookInfo) return;
        const key = getStorageKey(PROCESS_STATUS_PREFIX, currentBookInfo.key);
        await saveToStorage(key, chapterStatus);
    }
    function findChapterData(chapterNumber) { /* ... KEPT AS ORIGINAL ... */
        const wikiChapter = wikiChapters.find(ch => ch.number === chapterNumber);
        const sourceChapter = sourceChapters.find(ch => ch.number === chapterNumber);
        if (!wikiChapter) { logDebug(`No Wiki chapter data for: ${chapterNumber}`); return null; }
        if (!sourceChapter) { logDebug(`No Source chapter data for: ${chapterNumber}`); return null; }
        if (!sourceChapter.id) { logDebug(`Source chapter ${chapterNumber} missing 'id'.`); return null; }
        return { wiki: wikiChapter, source: sourceChapter };
    }

    // --- Button Handlers & Sync Control ---
    async function handleFetchWikiChapters() { /* ... KEPT AS ORIGINAL ... */
        if (!currentBookInfo) return; logToStatusUI("Đang tải DS chương Wikidich...");
        const btn = document.getElementById(UI_FETCH_WIKI_BTN_ID); if(btn) btn.disabled = true;
        try {
            wikiChapters = await WikiChapterFetcher.getAllChapters(location.href);
            const newStatus = {}; wikiChapters.forEach(ch => { newStatus[ch.number] = chapterStatus[ch.number] || 'pending'; });
            chapterStatus = newStatus;
            await saveToStorage(getStorageKey(WIKI_LIST_PREFIX, currentBookInfo.key), wikiChapters);
            await saveChapterStatus();
            logToStatusUI(`✅ Tải xong ${wikiChapters.length} chương Wikidich.`);
        } catch (error) { console.error("Error fetching Wikidich chapters:", error); logToStatusUI(`❌ Lỗi tải DS Wiki: ${error.message}`, true); wikiChapters = await loadFromStorage(getStorageKey(WIKI_LIST_PREFIX, currentBookInfo.key), []); }
        finally { if(btn) btn.disabled = isSyncRunning; updateUI(); }
    }
    async function handleFetchSourceChapters() { /* ... KEPT AS ORIGINAL ... */
        if (!currentBookInfo) return;
        const urlInput = document.getElementById(UI_SOURCE_URL_INPUT_ID); const url = urlInput?.value?.trim();
        if (!url) { logToStatusUI("Vui lòng nhập link nguồn.", true); return; }
        const adapter = detectAdapter(url);
        if (!adapter) { logToStatusUI("Link nguồn không được hỗ trợ hoặc không hợp lệ.", true); return; }
        const sourceBookId = adapter.extractBookId(url);
        if (!sourceBookId && adapter.requiresBookIdForDirectory !== false) { // Some adapters might not need bookId for dir
             logToStatusUI("Không thể trích xuất ID sách từ link nguồn (cần cho adapter này).", true); return;
        }
        logToStatusUI(`Đang tải DS chương từ ${adapter.name}...`);
        const btn = document.getElementById(UI_FETCH_SOURCE_BTN_ID); if(btn) btn.disabled = true;
        await saveToStorage(getStorageKey(SOURCE_URL_PREFIX, currentBookInfo.key), url);
        adapter.fetchDirectory(sourceBookId, async (chapters) => {
            if (chapters && chapters.length > 0) {
                sourceChapters = chapters;
                await saveToStorage(getStorageKey(SOURCE_LIST_PREFIX, currentBookInfo.key), sourceChapters);
                logToStatusUI(`✅ Tải xong ${sourceChapters.length} chương từ ${adapter.name}.`);
            } else { logToStatusUI(`⚠️ Không tải được chương nào từ ${adapter.name}.`, !chapters); sourceChapters = await loadFromStorage(getStorageKey(SOURCE_LIST_PREFIX, currentBookInfo.key), []); }
            if(btn) btn.disabled = isSyncRunning; updateUI();
        });
    }
    async function handleStartSync() { /* ... KEPT AS ORIGINAL ... */
        if (isSyncRunning) return;
        const rangeInput = document.getElementById(UI_RANGE_INPUT_ID); const range = parseRange(rangeInput?.value);
        if (!range) { logToStatusUI("Khoảng chương không hợp lệ.", true); return; }
        if (!wikiChapters.length || !sourceChapters.length) { logToStatusUI("Cần tải DS Wiki và Nguồn trước.", true); return; }
        await saveToStorage(getStorageKey(`${STORAGE_PREFIX}last_range_`, currentBookInfo.key), rangeInput.value);
        isSyncRunning = true; await GM_setValue(getStorageKey(IS_RUNNING_PREFIX, currentBookInfo.key), true);
        syncQueue = wikiChapters.map(ch => ch.number)
            .filter(num => num >= range.start && num <= range.end)
            .filter(num => ['pending', 'error', 'submit_triggered'].includes(chapterStatus[num] || 'pending'))
            .sort((a, b) => a - b);
        if (syncQueue.length === 0) {
            logToStatusUI(`Không có chương nào trong khoảng ${rangeInput.value} cần xử lý.`);
            isSyncRunning = false; await GM_setValue(getStorageKey(IS_RUNNING_PREFIX, currentBookInfo.key), false);
            updateUI(); return;
        }
        logToStatusUI(`🚀 Bắt đầu đồng bộ ${syncQueue.length} chương từ ${range.start} đến ${range.end === Infinity ? 'cuối' : range.end}...`);
        updateUI(); processNextChapter();
    }
    async function handleStopSync() { /* ... KEPT AS ORIGINAL ... */
        if (!isSyncRunning) return; logToStatusUI("⏹️ Đang dừng đồng bộ...");
        isSyncRunning = false; await GM_setValue(getStorageKey(IS_RUNNING_PREFIX, currentBookInfo.key), false);
        if (editPageTimeoutId) { clearTimeout(editPageTimeoutId); editPageTimeoutId = null; }
        if (currentChapterProcessing && chapterStatus[currentChapterProcessing] === 'processing') {
            chapterStatus[currentChapterProcessing] = 'pending'; await saveChapterStatus();
        }
        syncQueue = []; currentChapterProcessing = null;
        logToStatusUI("⏹️ Đồng bộ đã dừng."); updateUI();
    }
    async function handleClearHistory() { /* ... KEPT AS ORIGINAL ... */
        if (isSyncRunning) { logToStatusUI("Dừng đồng bộ trước khi xóa lịch sử.", true); return; }
        if (confirm(`Xóa lịch sử đồng bộ cho sách "${currentBookInfo.title}"?`)) {
            chapterStatus = {}; wikiChapters.forEach(ch => { chapterStatus[ch.number] = 'pending'; });
            await saveChapterStatus(); logToStatusUI("🗑️ Đã xóa lịch sử đồng bộ."); updateUI();
        }
    }
    async function processNextChapter() { /* ... KEPT AS ORIGINAL ... */
        if (!isSyncRunning || syncQueue.length === 0) {
            if (isSyncRunning) { logToStatusUI("🏁 Đã xử lý hết các chương."); handleStopSync(); }
            else { logDebug("Sync stopped or queue empty."); }
            updateUI(); return;
        }
        currentChapterProcessing = syncQueue.shift();
        const chapterData = findChapterData(currentChapterProcessing);
        if (!chapterData || !chapterData.wiki?.url || !chapterData.source?.id) {
            logToStatusUI(`❌ Thiếu dữ liệu cho chương ${currentChapterProcessing}. Bỏ qua.`, true);
            chapterStatus[currentChapterProcessing] = 'skipped'; currentChapterProcessing = null;
            await saveChapterStatus(); updateUI();
            setTimeout(processNextChapter, 50); return;
        }
        chapterStatus[currentChapterProcessing] = 'processing'; await saveChapterStatus();
        logToStatusUI(`⚙️ Đang xử lý chương ${currentChapterProcessing}...`);
        scrollToChapter(currentChapterProcessing); updateUI();
        const editUrl = `${chapterData.wiki.url}/chinh-sua#sync-${currentChapterProcessing}-${currentBookInfo.key}`;
        openEditPage(editUrl, currentChapterProcessing);
        if (editPageTimeoutId) clearTimeout(editPageTimeoutId);
        editPageTimeoutId = setTimeout(async () => {
             if (isSyncRunning && chapterStatus[currentChapterProcessing] === 'processing') {
                logToStatusUI(`⏰ Timeout chờ tab chỉnh sửa chương ${currentChapterProcessing}. Lỗi.`, true);
                chapterStatus[currentChapterProcessing] = 'error'; currentChapterProcessing = null;
                await saveChapterStatus(); updateUI();
                if(isSyncRunning) setTimeout(processNextChapter, NEXT_CHAPTER_DELAY);
             }
             editPageTimeoutId = null;
        }, EDIT_PAGE_TIMEOUT);
    }
    function openEditPage(url, chapterNumber) { /* ... KEPT AS ORIGINAL ... */
        try {
            const newTab = window.open(url, 'popupWindow', 'width=400,height=300,left=200,top=100,resizable=yes,scrollbars=yes');
             if (!newTab) throw new Error("Popup bị chặn hoặc lỗi mở tab.");
        } catch (e) {
             logToStatusUI(`❌ Lỗi mở tab sửa chương ${chapterNumber}: ${e.message}.`, true);
             if (isSyncRunning && currentChapterProcessing === chapterNumber) {
                 chapterStatus[chapterNumber] = 'error'; saveChapterStatus();
                 currentChapterProcessing = null; updateUI();
                 setTimeout(processNextChapter, NEXT_CHAPTER_DELAY);
             }
        }
    }
    async function handleEditTabUpdate(name, oldStatusJson, newStatusJson, remote) { /* ... KEPT AS ORIGINAL ... */
        if (!remote || !isSyncRunning || !currentChapterProcessing) return;
        let statusUpdate; try { statusUpdate = JSON.parse(newStatusJson); } catch(e) { logDebug("Error parsing status update:", e); return; }
        if (statusUpdate?.bookKey === currentBookInfo.key && statusUpdate?.chapterNumber === currentChapterProcessing) {
            const reportedStatus = statusUpdate.status; const chapterNum = statusUpdate.chapterNumber;
            logDebug(`Update từ tab sửa chương ${chapterNum}: ${reportedStatus}`);
            if (editPageTimeoutId) { clearTimeout(editPageTimeoutId); editPageTimeoutId = null; }
            if (['checked_ok', 'updated_hidden', 'error', 'submit_triggered'].includes(reportedStatus)) {
                 chapterStatus[chapterNum] = reportedStatus; await saveChapterStatus();
                 let msg = `Chương ${chapterNum}: `;
                 if(reportedStatus === 'checked_ok') msg += 'Kiểm tra OK.';
                 else if(reportedStatus === 'updated_hidden') msg += 'Đã cập nhật.';
                 else if(reportedStatus === 'submit_triggered') msg += 'Đã gửi cập nhật.';
                 else msg += 'Lỗi từ tab edit.';
                 logToStatusUI(msg);
                 currentChapterProcessing = null; updateUI();
                 setTimeout(processNextChapter, NEXT_CHAPTER_DELAY);
            } else logDebug(`Unknown status '${reportedStatus}' for chapter ${chapterNum}.`);
        }
    }

    // --- Edit Page Logic ---
    function getEditPageInfo() { /* ... KEPT AS ORIGINAL ... */
        const hash = location.hash; const match = hash.match(/^#sync-(\d+)-(.+)$/);
        if (match) { const chapterNumber = parseInt(match[1]); const bookKey = match[2]; return { chapterNumber, bookKey }; }
        return null;
    }

    async function checkAndProcessContent(editInfo) { // MODIFIED FOR EMPTY CONTENT
        const { chapterNumber, bookKey } = editInfo;
        logDebug(`Processing edit page for chapter ${chapterNumber}, bookKey: ${bookKey}`);

        const submittedChapter = sessionStorage.getItem(`${SCRIPT_ID}_submitted_chapter`);
        if (submittedChapter === String(chapterNumber)) {
            logDebug(`Post-submit state for chapter ${chapterNumber}. Reporting success.`);
            sessionStorage.removeItem(`${SCRIPT_ID}_submitted_chapter`);
            await reportStatusAndClose(bookKey, chapterNumber, 'updated_hidden', TAB_CLOSE_DELAY_SUBMIT);
            return;
        }

        const contentTextArea = document.getElementById('txtContentCn');
        const form = document.getElementById('formEditChapter');
        const submitButton = form?.querySelector('button[type="submit"], input[type="submit"]');

        if (!contentTextArea || !form || !submitButton) {
            logDebug("Edit page elements not found.");
            await reportStatusAndClose(bookKey, chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR); return;
        }

        const currentContent = contentTextArea.value || '';
        const hiddenContentPattern = /(\*{6,})\s*后面还有\s*\d+\s*个字内容被隐藏了\s*\1/i;
        const hasHiddenContent = hiddenContentPattern.test(currentContent);
        const isEmptyContent = currentContent.trim() === ''; // Check for empty content

        if (!hasHiddenContent && !isEmptyContent) { // If NOT hidden AND NOT empty
            logDebug(`No hidden/empty content for chapter ${chapterNumber}. OK.`);
            await reportStatusAndClose(bookKey, chapterNumber, 'checked_ok', TAB_CLOSE_DELAY_OK);
            return;
        }

        // If HAS hidden content OR IS empty, then proceed to fetch
        logDebug(`${hasHiddenContent ? 'Hidden content found' : (isEmptyContent ? 'Content is empty' : 'Proceeding to fetch') } for chapter ${chapterNumber}. Fetching source...`);

        const sourceListKey = getStorageKey(SOURCE_LIST_PREFIX, bookKey);
        const adapterStorageKey = getStorageKey(CURRENT_ADAPTER_PREFIX, bookKey);
        const chapters = await loadFromStorage(sourceListKey, []);
        const savedAdapterKeyJSON = await GM_getValue(adapterStorageKey, null);
        let actualAdapterKey = null;

        if (savedAdapterKeyJSON) { try { actualAdapterKey = JSON.parse(savedAdapterKeyJSON); } catch (e) { logDebug("Error parsing adapter key JSON on edit page:", e); } }

        if (!chapters || chapters.length === 0 || !actualAdapterKey || !apiAdapters[actualAdapterKey]) {
            logDebug("Missing source list, adapter info, or invalid adapter key on edit page.");
            await reportStatusAndClose(bookKey, chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR); return;
        }
        const sourceAdapter = apiAdapters[actualAdapterKey];
        if (sourceAdapter.requiresApi && FANQIE_API === FANQIE_API_DEFAULT) await initializeApiEndpoint();

        const sourceChapter = chapters.find(ch => ch.number === chapterNumber);
        if (!sourceChapter || !sourceChapter.id) {
            logDebug(`Could not find source chapter or ID for chapter ${chapterNumber}.`);
            await reportStatusAndClose(bookKey, chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR); return;
        }

        try {
            const fullContent = await new Promise((resolve) => sourceAdapter.fetchContent(sourceChapter.id, resolve));
            if (fullContent === null || fullContent.trim() === '') {
                logDebug(`Failed to fetch or received empty content from source for chapter ${chapterNumber}.`);
                await reportStatusAndClose(bookKey, chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR); return;
            }
            logDebug(`Fetched source content for chapter ${chapterNumber}. Length: ${fullContent.length}. Updating...`);
            contentTextArea.value = fullContent;
            contentTextArea.dispatchEvent(new Event('input', { bubbles: true }));
            contentTextArea.dispatchEvent(new Event('change', { bubbles: true }));
            logDebug(`Content updated. Submitting form for chapter ${chapterNumber}...`);
            sessionStorage.setItem(`${SCRIPT_ID}_submitted_chapter`, String(chapterNumber));
            const statusPayload = JSON.stringify({ bookKey, chapterNumber, status: 'submit_triggered' });
            await GM_setValue(EDIT_TAB_STATUS_PREFIX + bookKey, statusPayload);
            submitButton.click();
        } catch (fetchError) {
            logDebug(`Error fetching source content for chapter ${chapterNumber}:`, fetchError);
            await reportStatusAndClose(bookKey, chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR);
        }
    }

    async function reportStatusAndClose(bookKey, chapterNumber, status, closeDelay) { /* ... KEPT AS ORIGINAL ... */
        logDebug(`Reporting status '${status}' for chapter ${chapterNumber}, closing in ${closeDelay}ms.`);
        const statusPayload = JSON.stringify({ bookKey, chapterNumber, status });
        try { await GM_setValue(EDIT_TAB_STATUS_PREFIX + bookKey, statusPayload); } catch (e) { logDebug("Error reporting status:", e); }
        setTimeout(() => { logDebug(`Closing edit tab for chapter ${chapterNumber}.`); window.close(); }, closeDelay);
    }

    // --- Initialization and Page Routing ---
    async function initialize() { /* ... KEPT AS ORIGINAL (with panel creation but hidden by default) ... */
        logDebug(`Script initializing (v${SCRIPT_VERSION})...`);
        await initializeApiEndpoint();
        const path = location.pathname; const hash = location.hash;

        if (path.includes('/chinh-sua') && hash.startsWith('#sync-')) {
            logDebug("Running on Edit Page");
            const editInfo = getEditPageInfo();
            if (editInfo) {
                try { await new Promise(resolve => setTimeout(resolve, 500)); await checkAndProcessContent(editInfo); }
                catch (e) { console.error(`[${SCRIPT_ID}] Unhandled error on edit page:`, e); if (editInfo) await reportStatusAndClose(editInfo.bookKey, editInfo.chapterNumber, 'error', TAB_CLOSE_DELAY_ERROR); }
            } return;
        }

        const bookPageMatch = path.match(/^\/truyen\/([^\/]+)$/);
        if (bookPageMatch && !path.includes('/chuong-') && !path.endsWith('/chinh-sua')) {
            logDebug("Running on Book Page");
            currentBookInfo = getBookInfo(); if (!currentBookInfo) { logDebug("Could not get book info. Aborting."); return; }
            addStyles(); createMainUI(); // Panel created here, but display:none by default CSS in createMainUI
            detectSourceLinkOnPage(); await loadPersistedData();

            const wasRunning = await GM_getValue(getStorageKey(IS_RUNNING_PREFIX, currentBookInfo.key), false);
            if(wasRunning) {
                logDebug("Detected previous running state. Restarting sync...");
                const lastRangeStr = await loadFromStorage(getStorageKey(`${STORAGE_PREFIX}last_range_`, currentBookInfo.key));
                const rangeInput = document.getElementById(UI_RANGE_INPUT_ID);
                if (rangeInput && lastRangeStr) rangeInput.value = lastRangeStr;
                if (lastRangeStr) handleStartSync(); else { logDebug("Could not restore range."); handleStopSync(); }
            } else updateUI();

            const listenerKey = EDIT_TAB_STATUS_PREFIX + currentBookInfo.key;
            if(statusListenerId) GM_removeValueChangeListener(statusListenerId);
            statusListenerId = GM_addValueChangeListener(listenerKey, handleEditTabUpdate);
            logDebug(`Listening for edit tab status on key: ${listenerKey}`);

            const toggleButton = document.createElement('button');
            toggleButton.id = UI_TOGGLE_ID; toggleButton.textContent = '⚙️';
            toggleButton.title = 'Hiện/Ẩn Bảng Đồng Bộ Sách';
            toggleButton.onclick = () => {
                const panel = document.getElementById(UI_PANEL_ID);
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
                    if (panel.style.display === 'flex') updateUI();
                }
            };
            document.body.appendChild(toggleButton);
            GM_registerMenuCommand("Hiện/Ẩn Bảng Đồng Bộ Sách", () => toggleButton.click(), 's'); // Shortcut key 's'
        } else logDebug("Not a target page.");
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') initialize();
    else window.addEventListener('DOMContentLoaded', initialize, { once: true });
})();