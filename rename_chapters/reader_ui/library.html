<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Thư viện truyện</title>
  <script>
    (() => {
      const SETTINGS_KEY = "reader.ui.settings.v3";
      const THEME_KEY = "reader.ui.theme.cache.v1";
      const defaults = {
        fontFamily: "'Noto Serif', 'Palatino Linotype', 'Times New Roman', serif",
        fontSize: 21,
        lineHeight: 1.9,
        paragraphSpacing: 1.1,
        textAlign: "justify",
        panelTransparency: "clear",
        starStyle: "classic",
        backgroundMotion: "on",
      };
      const fallbackTheme = {
        effect: "stars",
        tokens: {
          bg: "#090a1a",
          bg2: "#111433",
          surface: "#11162d",
          surface_alt: "#151f42",
          text: "#eaf2ff",
          muted: "#8ca3d4",
          accent: "#77b8ff",
          glow: "#9fd0ff",
          particle: "#ffffff",
        },
      };
      const root = document.documentElement;
      root.classList.add("theme-booting");
      let settings = { ...defaults };
      let theme = fallbackTheme;
      try {
        const rawSettings = localStorage.getItem(SETTINGS_KEY);
        if (rawSettings) settings = { ...defaults, ...JSON.parse(rawSettings) };
      } catch {}
      try {
        const rawTheme = localStorage.getItem(THEME_KEY);
        if (rawTheme) {
          const parsed = JSON.parse(rawTheme);
          if (parsed && parsed.tokens) theme = parsed;
        }
      } catch {}
      for (const [key, value] of Object.entries(theme.tokens || {})) {
        root.style.setProperty(`--${String(key).split("_").join("-")}`, value);
      }
      root.style.setProperty("--reader-font-family", settings.fontFamily);
      root.style.setProperty("--reader-font-size", `${settings.fontSize}px`);
      root.style.setProperty("--reader-line-height", `${settings.lineHeight}`);
      root.style.setProperty("--reader-paragraph-spacing", `${settings.paragraphSpacing}em`);
      root.style.setProperty("--reader-text-align", settings.textAlign);
      const effects = ["effect-stars", "effect-sparkle", "effect-bubbles", "effect-leaves", "effect-snow"];
      const stars = ["star-style-classic", "star-style-dense", "star-style-bling"];
      const panelStyles = ["panel-style-clear", "panel-style-balanced", "panel-style-solid"];
      root.classList.remove(...effects, ...stars);
      root.classList.add(`effect-${theme.effect || "stars"}`);
      root.classList.add(`star-style-${settings.starStyle || "classic"}`);
      root.classList.remove(...panelStyles);
      root.classList.add(`panel-style-${settings.panelTransparency || "clear"}`);
      root.classList.toggle("effects-paused", (settings.backgroundMotion || "on") !== "on");
    })();
  </script>
  <link rel="stylesheet" href="./styles.css?v=20260220-vb10">
</head>
<body data-page="library" class="mpa-body">
  <script>
    (() => {
      const root = document.documentElement;
      const body = document.body;
      const effects = ["effect-stars", "effect-sparkle", "effect-bubbles", "effect-leaves", "effect-snow"];
      const stars = ["star-style-classic", "star-style-dense", "star-style-bling"];
      const panelStyles = ["panel-style-clear", "panel-style-balanced", "panel-style-solid"];
      body.classList.remove(...effects, ...stars, ...panelStyles);
      for (const cls of [...effects, ...stars, ...panelStyles]) {
        if (root.classList.contains(cls)) body.classList.add(cls);
      }
      body.classList.toggle("effects-paused", root.classList.contains("effects-paused"));
      body.classList.toggle("effects-lite", root.classList.contains("effects-lite"));
      root.classList.remove("theme-booting");
    })();
  </script>

  <div id="fx-layer" aria-hidden="true"></div>

  <header class="topbar sticky-topbar">
    <div class="brand">
      <h1 id="app-title"></h1>
      <p id="app-subtitle"></p>
    </div>
    <nav class="nav-tabs" aria-label="Điều hướng trang">
      <a id="nav-library" class="tab-btn" href="/library"></a>
      <a id="nav-search" class="tab-btn" href="/search"></a>
      <a id="nav-explore" class="tab-btn" href="/explore"></a>
    </nav>
    <div class="topbar-actions">
      <input id="search-input" type="search" autocomplete="off">
      <button id="btn-go-search" class="btn" type="button"></button>
      <button id="btn-clear-cache" class="btn" type="button"></button>
      <button id="btn-open-settings" class="btn" type="button"></button>
    </div>
  </header>

  <div id="status-inline" class="status-inline" role="status" aria-live="polite" aria-busy="false"></div>

  <main class="pages single-main one-col">
    <section class="panel library-panel history-panel">
      <div class="panel-head">
        <h2 id="history-title"></h2>
        <span id="history-count" class="tag"></span>
      </div>
      <div id="history-grid" class="library-grid"></div>
      <p id="history-empty" class="empty-text hidden"></p>
    </section>

    <section class="panel library-panel">
      <div class="panel-head">
        <h2 id="library-title"></h2>
        <div class="cover-btns">
          <button id="btn-import" class="btn btn-primary" type="button"></button>
          <button id="btn-import-url" class="btn" type="button"></button>
          <button id="btn-manage-vbook" class="btn" type="button"></button>
          <span id="library-count" class="tag"></span>
        </div>
      </div>
      <div id="library-grid" class="library-grid"></div>
      <p id="library-empty" class="empty-text hidden"></p>
    </section>
  </main>

  <dialog id="book-actions-dialog" class="dialog book-actions-dialog">
    <div class="dialog-head">
      <h3 id="book-actions-title"></h3>
      <button id="btn-close-book-actions" class="btn btn-small" type="button"></button>
    </div>
    <p id="book-actions-subtitle" class="dialog-subtitle"></p>
    <div class="book-actions-grid">
      <button id="btn-action-open-book" class="btn" type="button"></button>
      <button id="btn-action-open-reader" class="btn" type="button"></button>
      <button id="btn-action-export-txt" class="btn" type="button"></button>
      <button id="btn-action-export-epub" class="btn" type="button"></button>
      <button id="btn-action-delete-book" class="btn" type="button"></button>
    </div>
  </dialog>

  <aside id="settings-drawer" class="settings-drawer" aria-hidden="true">
    <div class="settings-head">
      <h3 id="settings-title"></h3>
      <button id="btn-close-settings" class="btn btn-small" type="button"></button>
    </div>
    <form id="settings-form" class="settings-form">
      <label>
        <span id="label-theme"></span>
        <select id="theme-select"></select>
      </label>
      <label>
        <span id="label-panel-transparency"></span>
        <select id="panel-transparency-select">
          <option id="panel-clear" value="clear"></option>
          <option id="panel-balanced" value="balanced"></option>
          <option id="panel-solid" value="solid"></option>
        </select>
      </label>
      <label>
        <span id="label-font-family"></span>
        <select id="font-family-select"></select>
      </label>
      <label>
        <span id="label-star-style"></span>
        <select id="star-style-select">
          <option id="star-style-classic" value="classic"></option>
          <option id="star-style-dense" value="dense"></option>
          <option id="star-style-bling" value="bling"></option>
        </select>
      </label>
      <label>
        <span id="label-background-motion"></span>
        <select id="background-motion-select">
          <option id="motion-on" value="on"></option>
          <option id="motion-off" value="off"></option>
        </select>
      </label>
      <label>
        <span id="label-font-size"></span>
        <input id="font-size-input" type="range" min="15" max="36" step="1">
        <small id="font-size-value"></small>
      </label>
      <label>
        <span id="label-text-align"></span>
        <select id="text-align-select">
          <option id="align-justify" value="justify">Đều hai bên</option>
          <option id="align-left" value="left">Canh trái</option>
          <option id="align-center" value="center">Canh giữa</option>
        </select>
      </label>
      <label>
        <span id="label-line-height"></span>
        <input id="line-height-input" type="range" min="1.2" max="2.6" step="0.05">
        <small id="line-height-value"></small>
      </label>
      <label>
        <span id="label-paragraph-spacing"></span>
        <input id="paragraph-spacing-input" type="range" min="0.2" max="2.2" step="0.05">
        <small id="paragraph-spacing-value"></small>
      </label>
      <label>
        <span id="label-reading-mode"></span>
        <select id="reading-mode-select">
          <option id="mode-flip" value="flip"></option>
          <option id="mode-horizontal" value="horizontal"></option>
          <option id="mode-vertical" value="vertical"></option>
          <option id="mode-hybrid" value="hybrid"></option>
        </select>
      </label>
      <label>
        <span id="label-mini-bars-enabled"></span>
        <select id="mini-bars-enabled-select">
          <option id="mini-bars-on" value="on"></option>
          <option id="mini-bars-off" value="off"></option>
        </select>
      </label>
      <div class="settings-actions">
        <button id="btn-save-settings" class="btn btn-primary" type="submit"></button>
        <button id="btn-reset-settings" class="btn" type="button"></button>
      </div>
    </form>
  </aside>
  <div id="settings-backdrop" class="settings-backdrop" hidden></div>

  <dialog id="import-dialog" class="dialog">
    <form id="import-form" method="dialog">
      <h3 id="import-title"></h3>
      <label>
        <span id="import-file-label"></span>
        <input id="import-file" name="file" type="file" accept=".txt,.epub" required>
      </label>
      <label>
        <span id="import-lang-label"></span>
        <select id="import-lang" name="lang_source">
          <option id="import-lang-zh" value="zh"></option>
          <option id="import-lang-vi" value="vi"></option>
        </select>
      </label>
      <label>
        <span id="import-book-title-label"></span>
        <input id="import-book-title" name="title" type="text" placeholder="Để trống để lấy tên file">
      </label>
      <label>
        <span id="import-author-label"></span>
        <input id="import-author" name="author" type="text" placeholder="Không bắt buộc">
      </label>
      <div class="dialog-actions">
        <button id="btn-import-cancel" class="btn" type="button"></button>
        <button id="btn-import-submit" class="btn btn-primary" type="submit"></button>
      </div>
    </form>
  </dialog>

  <dialog id="import-url-dialog" class="dialog">
    <form id="import-url-form" method="dialog">
      <h3 id="import-url-title"></h3>
      <label>
        <span id="import-url-label"></span>
        <input id="import-url-input" name="url" type="url" inputmode="url" autocomplete="off" placeholder="https://..." required>
      </label>
      <label>
        <span id="import-url-plugin-label"></span>
        <select id="import-url-plugin" name="plugin_id">
          <option id="import-url-plugin-auto" value=""></option>
        </select>
      </label>
      <div class="dialog-actions">
        <button id="btn-import-url-cancel" class="btn" type="button"></button>
        <button id="btn-import-url-submit" class="btn btn-primary" type="submit"></button>
      </div>
    </form>
  </dialog>

  <dialog id="vbook-manager-dialog" class="dialog vbook-manager-dialog">
    <div class="dialog-head">
      <h3 id="vbook-manager-title"></h3>
      <button id="btn-vbook-manager-close" class="btn btn-small" type="button"></button>
    </div>
    <p id="vbook-manager-hint" class="dialog-subtitle"></p>

    <div class="vbook-manager-grid">
      <section class="vbook-manager-pane">
        <div class="vbook-manager-pane-head">
          <h4 id="vbook-installed-title"></h4>
          <button id="btn-vbook-refresh-installed" class="btn btn-small" type="button"></button>
        </div>
        <div class="name-preview-table-wrap">
          <table class="name-preview-table">
            <thead>
              <tr>
                <th id="vbook-col-name"></th>
                <th id="vbook-col-meta"></th>
                <th id="vbook-col-action"></th>
              </tr>
            </thead>
            <tbody id="vbook-installed-body"></tbody>
          </table>
        </div>
      </section>

      <section class="vbook-manager-pane">
        <div class="vbook-manager-pane-head">
          <h4 id="vbook-repo-title"></h4>
          <button id="btn-vbook-refresh-repo" class="btn btn-small" type="button"></button>
        </div>
        <div class="vbook-repo-picker">
          <label>
            <span id="vbook-repo-label"></span>
            <select id="vbook-repo-select"></select>
          </label>
          <label>
            <span id="vbook-repo-custom-label"></span>
            <input id="vbook-repo-custom-input" type="url" placeholder="https://.../repository.json">
          </label>
          <div class="vbook-repo-actions">
            <button id="btn-vbook-load-custom-repo" class="btn btn-small" type="button"></button>
            <button id="btn-vbook-add-repo" class="btn btn-small" type="button"></button>
            <button id="btn-vbook-remove-repo" class="btn btn-small" type="button"></button>
            <button id="btn-vbook-save-repos" class="btn btn-small btn-primary" type="button"></button>
          </div>
        </div>
        <div class="name-preview-table-wrap">
          <table class="name-preview-table">
            <thead>
              <tr>
                <th id="vbook-repo-col-name"></th>
                <th id="vbook-repo-col-meta"></th>
                <th id="vbook-repo-col-action"></th>
              </tr>
            </thead>
            <tbody id="vbook-repo-body"></tbody>
          </table>
        </div>
        <p id="vbook-repo-errors" class="empty-text hidden"></p>
      </section>
    </div>

    <form id="vbook-install-url-form" class="vbook-install-url-form">
      <label>
        <span id="vbook-plugin-url-label"></span>
        <input id="vbook-plugin-url-input" type="url" required placeholder="https://.../plugin.zip">
      </label>
      <label>
        <span id="vbook-plugin-id-label"></span>
        <input id="vbook-plugin-id-input" type="text" placeholder="tùy chọn">
      </label>
      <button id="btn-vbook-install-url" class="btn btn-primary" type="submit"></button>
    </form>

    <form id="vbook-install-local-form" class="vbook-install-local-form">
      <label>
        <span id="vbook-plugin-file-label"></span>
        <input id="vbook-plugin-file-input" type="file" accept=".zip,application/zip" required>
      </label>
      <label>
        <span id="vbook-plugin-id-local-label"></span>
        <input id="vbook-plugin-id-local-input" type="text" placeholder="tùy chọn">
      </label>
      <button id="btn-vbook-install-local" class="btn btn-primary" type="submit"></button>
    </form>

    <section class="vbook-runtime-pane">
      <div class="vbook-manager-pane-head">
        <h4 id="vbook-runtime-title"></h4>
        <button id="btn-vbook-reload-settings" class="btn btn-small" type="button"></button>
      </div>
      <p id="vbook-runtime-hint" class="dialog-subtitle"></p>

      <div class="vbook-runtime-subhead">
        <h5 id="vbook-runtime-global-title"></h5>
      </div>
      <div class="vbook-runtime-grid">
        <label>
          <span id="vbook-global-delay-label"></span>
          <input id="vbook-global-request-delay-ms" type="number" min="0" max="15000" step="50">
        </label>
        <label>
          <span id="vbook-global-threads-label"></span>
          <input id="vbook-global-download-threads" type="number" min="1" max="16" step="1">
        </label>
        <label>
          <span id="vbook-global-prefetch-label"></span>
          <input id="vbook-global-prefetch-unread-count" type="number" min="0" max="50" step="1">
        </label>
      </div>
      <div class="vbook-repo-actions">
        <button id="btn-vbook-save-global-settings" class="btn btn-small btn-primary" type="button"></button>
      </div>

      <div class="vbook-runtime-divider"></div>

      <div class="vbook-runtime-subhead">
        <h5 id="vbook-runtime-plugin-title"></h5>
      </div>
      <div class="vbook-runtime-grid">
        <label>
          <span id="vbook-runtime-plugin-label"></span>
          <select id="vbook-runtime-plugin-select"></select>
        </label>
        <label>
          <span id="vbook-plugin-delay-label"></span>
          <input id="vbook-plugin-request-delay-ms" type="number" min="0" max="15000" step="50" placeholder="mặc định global">
        </label>
        <label>
          <span id="vbook-plugin-threads-label"></span>
          <input id="vbook-plugin-download-threads" type="number" min="1" max="16" step="1" placeholder="mặc định global">
        </label>
        <label>
          <span id="vbook-plugin-prefetch-label"></span>
          <input id="vbook-plugin-prefetch-unread-count" type="number" min="0" max="50" step="1" placeholder="mặc định global">
        </label>
        <label class="vbook-runtime-wide">
          <span id="vbook-plugin-supplemental-label"></span>
          <textarea id="vbook-plugin-supplemental-code" rows="4" spellcheck="false" placeholder="var token = &quot;...&quot;;"></textarea>
        </label>
      </div>
      <p id="vbook-plugin-fallback-hint" class="dialog-subtitle"></p>
      <div class="vbook-repo-actions">
        <button id="btn-vbook-save-plugin-settings" class="btn btn-small btn-primary" type="button"></button>
        <button id="btn-vbook-clear-plugin-settings" class="btn btn-small" type="button"></button>
      </div>
    </section>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module" src="./js/pages/library_page.js?v=20260220-vb11"></script>
</body>
</html>
