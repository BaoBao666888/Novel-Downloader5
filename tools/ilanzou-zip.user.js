// ==UserScript==
// @name         iLanZou Tr√¨nh qu·∫£n l√Ω
// @namespace    local.ilanzou.zip
// @author       QuocBao
// @version      0.2.2
// @description  Duy·ªát share iLanZou, t√¨m ki·∫øm, t·∫£i file l·∫ª ho·∫∑c zip theo l·ª±a ch·ªçn.
// @icon         data:image/png;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/FRwD/xkkB/8RFEP/CPxr/wDoc/741HP+8MBz/uiwc/7gmHP+2IRz/tBwc/7IZHP+yGBz/shgc/7IYHP+yGBz/shgc/7IYHP+yGBz/sxkc/K8VHPuvFxz+tB8c/7cmHP+5LRn/ujIJ/7E+AP+4NAAAAAAAAAAAAAAAAAD/y1MA/8xVE//IT2//xkrA/8RE3//CP+P/wDnj/7404/+8MOP/uivj/7gm4/+2IOP/sxzj/7IZ4/+yGOP/shjj/7IY4/+yGOP/shjj/rEX4/yvFOP9rxXj/bIa4/+1IeP/tynk/7ow2v+8N6f/vz9O/8BGCP/AQwAAAAAA/9BhAP/RYxb/zlyl/8tW+v/JUf//x03//8VH///DQv//wT3//784//+9M///uy7//7kp//+3JP//tR///7Mb//+yGP//shj//7IY//2vFf/8rRD//a8S//+yGP//tSD//7cn//+5Lv//vDX//748///AQ+//wkp8/8VQCf/ETQD/2YAC/9RqfP/SZf3/z2D//81b///LVv//yVH//8dM///FR///w0L//8E9//+/OP//vTL//7st//+5Kf//tiP//7Uf//+zGv/8rhL//KwM//+vEf//shj//7Qf//+3Jv//uS3//7w0//++O///wEL//8JJ///EUPL/x1Vd/7tIAP/aeB//13PS/9Vv///Tav//0WT//89f///NWv//y1X//8lQ///HS///xUb//8NB///BPP//vzf//7wy//+7Lf/+uCf/+68V//2sCv//rw///7IX//+0Hf//tiX//7ks//+7M/7/vTn//8BA///CSP//xU///8dW///JXLz/ymET/9uAQ//bfez/2Xj//9dz///Vbv//02n//9Fk///PX///zVr//8tV///JUP//x0v//8VG///CQf//wTz//742//uzH//8rAn//68O//+xFv//tB3//7Yj//+4Kv//uzH//704/v+/QP//wUf//8RO///GVf//yVz//8ti6f/MZjr/3ohB/9+G6//dgv//233//9l3///Xcv//1W7//9Np///QY///zl7//81Z///LVP//yE///8ZK///FRv/7uS3//KwM//+uDf//sRT+/7Qb//+2I///uCn//7ow//+9N///vz7+/8JF/v/DTf//xlP//8ha///LYv//zWju/81rSf/ijyP/4o/X/+GL///fhv//3YH//9p8///Yd///13L//9Vt///SaP//0GP//85e///NWf//y1X//MJE//quE///rgz//7ET//+zGv//tSH//7go//+6L///vDb//749///BRP//w0v//8ZS///IWf//ymD+/8xn///Pbuf/0HE2/+OTBP/ll4f/5ZT//+OP///hiv//3oX//9yA///ae///2Hb//9Zx///UbP//02f//9Fi//7NW//5tij//awL//+wEv//shn//7Qg//+3J///uS7//7w1/v++PP//wUP//8NK///FUf//yFj+/8pf///MZv//zm7//9Bzvf/SdRP/6J0A/+idG//onK//5pn9/+SU///ij///4Ir//96F///cgP//2nv//9h2///Wcf//1W3/+sVO//qtEf//sBD//7IY//+0H///tib//7kt//+7NP//vjv//8BC///CSf//xVD//8dX///JXv//zGX//85s///Qc/D/0XZY/853AP/xrAD/6J4A/+mhGf/pn37/6JzW/+aZ/f/kk///4o7//+CJ///ehP//3H///9p7//7Wc//4uDH//q4O//+yF///tB7//7Yl//+5LP//uzP//706///AQf//wkj//8RP///HVv//yV3//8tk///Oa///0HLu/9F2e//TeQj/0ngAAAAAAAAAAAD/7KEA//GeAf/qoz//6qLs/+id///mmP//5JP//+KO///gif//3oX/+9Bp//iuGf//sRX//7Qd//+2JP//uCv//7sy//+9Of//v0D//8JH///ETv//x1T+/8lc///LYvD/zWnT/89vo//RdEj/0XsH/9F4AAAAAAAAAAAAAAAAAAAAAAD/7akA/+2pEP/tqLz/7Kb//+qi///onP//5Zf//+ST//7gi//2vkT//K8U//+zHP//tiP//7gq//+7MP//vTf//78+///BRv//w03//8ZU///JW///y2L9/81me//PbRP/0XEI/9ZvAP/NcQAAAAAAAAAAAAAAAAAAAAAAAAAAAP/sqwD/7qoA/+2qTP/tquL/7an//+ul///qof/+5pn/98xk//evG///shr//7Ui//+4KP//ujD//702/v+/Pf//wUT//8NM///GUv//yFr//8pg///NZ/T/zWtP/81qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/rqgD/6asC/+2pQf/tqaH/7arG/+ymv/fIWtr3rx3//rIY//+1IP//tyf//7ku//+8Nf//vjz//8FD///DSv//xVL//8hY///KX///zGb//85s2P/OcCP/zm8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAO/NYwAAAAAA/euiB//vrRL97rEO+64RaP+yF/j/tB///7cm//+5Lf//vDT+/747/v/AQv//wkn//8VQ///HV///yV7//8xl///ObP//0HCO/89zBP/PcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+zGQD/shYT/7Qesf+2Jf//uSz//7sz//++Ov//wEH//8JI///FT/7/x1b+/8ld/v/MZP//zmv//9BxzP/RdCb/0HMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/70gAP+3JwD/tyUu/7grxP+6Mv//vTn//79A///CR///xE7//8dV///JXP//y2P//85q///PcNj/0XNF/89vAP/SdQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/7svAP+0QAD/uTAk/7w3l/+/Puv/wUb+/8RN///GVP//yFv//8ti///NafP/z26w/9ByNP/ShgH/0HUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+/PgD/vzwJ/8BDPP/DS4P/xVKr/8hZvP/KX7D/zGWO/85rTv/Pbw//zmwA/890AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/y1MA/9FSAf/GVQn/yVwP/8tiC//LZgL/ymUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////////////////////////4AAAB8AAAAOAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAcAAAAHgAAAD8AAAD/gAAD/4AAA//AAAP//AAH//4AD///AA///4A////g////////////////////////////8=
// @match        https://www.ilanzou.com/s/*
// @grant        GM_xmlhttpRequest
// @connect      api.ilanzou.com
// @connect      *
// @downloadURL  https://raw.githubusercontent.com/BaoBao666888/Novel-Downloader5/main/tools/ilanzou-zip.user.js
// @updateURL    https://raw.githubusercontent.com/BaoBao666888/Novel-Downloader5/main/tools/ilanzou-zip.user.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js
// ==/UserScript==

!function(){"use strict";const e="https://api.ilanzou.com",n="ilz-shadow-host",t="ilz-manager-btn",i="ilz-manager-panel",o="ilz-list-body",r="ilz-breadcrumbs",l="ilz-select-all",a="ilz-search",s="ilz-scope",c="ilz-index",d="ilz-refresh",u="ilz-close",f="ilz-status",p="ilz-progress",h="ilz-speed",m="ilz-eta",g="ilz-cancel",y="ilz-selection-info",x="ilz-download-selected",z="ilz-download-folder";let $=null;const w={shareId:"",shareCode:"",shareInfo:null,rootItems:[],currentFolderId:null,pathStack:[{name:"G·ªëc",folderId:null}],currentItems:[],itemStore:new Map,selectedKeys:new Set,searchQuery:"",searchScope:"current",indexItems:[],indexing:!1,loading:!1,downloading:!1,cancelRequested:!1,currentRequest:null,transfer:{startTime:0,totalBytes:0,downloadedBytes:0}};function v(e){return $?$.getElementById(e):null}function b(e){const n=CryptoJS.enc.Utf8.parse("lanZouY-disk-app");return CryptoJS.AES.encrypt(e,n,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString().toUpperCase()}function I(){let e=localStorage.getItem("uuid");return e||(e=crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,e=>{const n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)}),localStorage.setItem("uuid",e)),e}async function k(n,t){const i=function(n,t){const i={devType:6,devModel:"Chrome",uuid:I(),extra:2,timestamp:b(String(Date.now())),...t},o=new URLSearchParams;return Object.keys(i).forEach(e=>{const n=i[e];null!=n&&""!==n&&o.set(e,String(n))}),`${e}${n}?${o.toString()}`}(n,t),o=await function(e){return new Promise((n,t)=>{GM_xmlhttpRequest({method:"POST",url:e,headers:{Accept:"application/json, text/plain, */*"},onload:e=>{try{const t=JSON.parse(e.responseText);n(t)}catch(e){t(new Error("Ph·∫£n h·ªìi JSON kh√¥ng h·ª£p l·ªá"))}},onerror:()=>t(new Error("L·ªói m·∫°ng")),ontimeout:()=>t(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}(i);if(!o||200!==o.code)throw new Error(o&&o.msg||"API error");return o}function S(n,t){const i=Date.now(),o=b(`${n}|`),r=b(`${n}|${i}`),l=new URLSearchParams({downloadId:o,enable:1,devType:6,uuid:I(),timestamp:b(String(i)),auth:r,shareId:t});return`${e}/unproved/file/redirect?${l.toString()}`}function T(e,n){return new Promise((t,i)=>{w.currentRequest=GM_xmlhttpRequest({method:"GET",url:e,headers:{Referer:"https://www.ilanzou.com/"},responseType:"arraybuffer",onprogress:e=>{n&&n(e)},onload:e=>{w.currentRequest=null,e.status>=200&&e.status<400?t(e.response):i(new Error(`HTTP ${e.status}`))},onerror:()=>{w.currentRequest=null,i(new Error("T·∫£i th·∫•t b·∫°i"))},ontimeout:()=>{w.currentRequest=null,i(new Error("H·∫øt th·ªùi gian t·∫£i"))}})})}function L(e,n){const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=n,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(t.href)}function R(e){return e?String(e).replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"unnamed"}function B(e,n){if(!n.has(e))return n.add(e),e;const t=e.lastIndexOf("."),i=t>0?e.slice(0,t):e,o=t>0?e.slice(t):"";let r=1,l=`${i} (${r})${o}`;for(;n.has(l);)r+=1,l=`${i} (${r})${o}`;return n.add(l),l}function C(e){const n=Number(e);return!Number.isFinite(n)||n<=0?0:Math.round(1024*n)}function E(e){if(!e&&0!==e)return"";const n=["B","KB","MB","GB"];let t=e,i=0;for(;t>=1024&&i<n.length-1;)t/=1024,i+=1;return`${t.toFixed(1)} ${n[i]}`}function q(e){if(2===e.fileType)return"Th∆∞ m·ª•c";const n=function(e){const n=e.lastIndexOf(".");return n<0?"":e.slice(n+1).toLowerCase()}(e.name||"");return n?n.toUpperCase():"T·∫≠p tin"}function M(e){return 2===e.fileType||e.isFolder?`d:${e.folderId}`:`f:${e.fileId}`}function K(e,n){const t=2===e.fileType,i=R(e.folderName||e.fileName||e.name||(t?"folder":"file")),o=t?`${n}${i}/`:`${n}${i}`,r={key:M(e),name:i,path:o,fileType:t?2:1,fileId:e.fileId||null,folderId:e.folderId||null,sizeBytes:C(e.fileSize),sizeRaw:e.fileSize||0,updTime:e.updTime||""};return w.itemStore.set(r.key,r),r}async function A(e,n){return k("/unproved/recommend/list",{shareId:e,code:n,userId:"",type:0,offset:1,limit:60})}async function N(e,n,t){return k("/unproved/share/list",{shareId:e,folderId:n||null,offset:t,limit:60})}async function F(e,n,t,i,o,r,l){let a=1,s=1;for(;a<=s;){if(w.cancelRequested)return;const c=await N(e,n,a);s=c.totalPage||1;const d=Array.isArray(c.list)?c.list:[];for(const n of d){if(w.cancelRequested)return;if(2===n.fileType){const a=R(n.folderName||n.name||"folder");await F(e,n.folderId,`${t}${a}/`,i,o,r,l)}else if(1===n.fileType){if(r.has(n.fileId))continue;const e=R(n.fileName||n.name||"file"),a=B(`${t}${e}`,o);r.add(n.fileId),i.push({fileId:n.fileId,fileName:e,path:a,sizeBytes:C(n.fileSize)}),l&&l()}}a+=1}}async function H(e,n,t,i,o){let r=1,l=1;for(;r<=l;){if(w.cancelRequested)return;const a=await N(e,n,r);l=a.totalPage||1;const s=Array.isArray(a.list)?a.list:[];for(const n of s){if(w.cancelRequested)return;const r=K(n,t);i.push(r),2===r.fileType?(o.folders+=1,await H(e,r.folderId,r.path,i,o)):o.files+=1}r+=1}}function P(e){const n=v(f);n&&(n.textContent=e||"")}function U(e){const n=v(p);n&&(n.textContent=e||"")}function j(e){const n=v(h);n&&(n.textContent=e||"")}function _(e){const n=v(m);n&&(n.textContent=e||"")}function D(){const e=(Date.now()-w.transfer.startTime)/1e3;if(e<=0)return;const n=w.transfer.downloadedBytes/e,t=n?`${E(n)}/s`:"";if(j(t?`T·ªëc ƒë·ªô: ${t}`:""),w.transfer.totalBytes>0&&n>0){_(`C√≤n l·∫°i: ${function(e){if(!Number.isFinite(e)||e<=0)return"";let n=Math.round(e);const t=Math.floor(n/3600);n-=3600*t;const i=Math.floor(n/60);n-=60*i;const o=[];return t&&o.push(`${t}h`),i&&o.push(`${i}m`),o.push(`${n}s`),o.join(" ")}(Math.max(0,w.transfer.totalBytes-w.transfer.downloadedBytes)/n)}`)}else _("")}function G(e){w.transfer.startTime=Date.now(),w.transfer.totalBytes=e||0,w.transfer.downloadedBytes=0,j(""),_("")}function O(){if(w.pathStack.length<=1)return"";const e=w.pathStack.slice(1).map(e=>R(e.name));return e.length?`${e.join("/")}/`:""}async function J(){if(!w.shareInfo)if(w.loading=!0,P("ƒêang t·∫£i chia s·∫ª..."),w.shareInfo=await async function(){let e=new URLSearchParams(location.search).get("code")||"";if(!e){const n=sessionStorage.getItem(`ilz_code_${w.shareId}`);n&&(e=n)}for(e&&(w.shareCode=e);;){const n=await A(w.shareId,e);if(1===n.status||2===n.status){const t=2===n.status?"M√£ sai. Nh·∫≠p l·∫°i:":"C·∫ßn m√£ truy c·∫≠p. Nh·∫≠p m√£:";if(e=(window.prompt(t,e||"")||"").trim(),!e)throw new Error("ƒê√£ h·ªßy");w.shareCode=e,sessionStorage.setItem(`ilz_code_${w.shareId}`,e);continue}if(!n.list||!n.list.length)throw new Error("Kh√¥ng t√¨m th·∫•y n·ªôi dung chia s·∫ª");return w.shareCode=e||"",n.list[0]}}(),w.rootItems=Array.isArray(w.shareInfo.fileList)?w.shareInfo.fileList:[],1===w.rootItems.length&&2===w.rootItems[0].fileType){const e=w.rootItems[0];w.pathStack=[{name:"G·ªëc",folderId:null},{name:e.folderName||e.name||"Th∆∞ m·ª•c",folderId:e.folderId}],w.currentFolderId=e.folderId,await Q()}else w.currentFolderId=null,w.pathStack=[{name:"G·ªëc",folderId:null}],await Q()}function Z(e){return e.slice().sort((e,n)=>e.fileType!==n.fileType?2===e.fileType?-1:1:(e.name||"").localeCompare(n.name||""))}async function Q(){w.loading=!0,W();const e=O();if(!w.currentFolderId)return w.currentItems=w.rootItems.map(n=>K(n,e)),w.currentItems=Z(w.currentItems),w.loading=!1,void W();const n=await async function(e,n){let t=1,i=1;const o=[];for(;t<=i;){if(w.cancelRequested)return o;const r=await N(e,n,t);i=r.totalPage||1,o.push(...r.list||[]),t+=1}return o}(w.shareId,w.currentFolderId);w.currentItems=Z(n.map(n=>K(n,e))),w.loading=!1,W()}function Y(){const e=w.searchQuery.trim().toLowerCase();let n=[];return n="all"===w.searchScope?w.indexItems:w.currentItems,e?n.filter(n=>n.path.toLowerCase().includes(e)):n}function V(){const e=v(y);if(!e)return;const n=Array.from(w.selectedKeys).map(e=>w.itemStore.get(e)).filter(Boolean),t=n.filter(e=>1===e.fileType).length,i=n.filter(e=>2===e.fileType).length,o=n.filter(e=>1===e.fileType).reduce((e,n)=>e+(n.sizeBytes||0),0),r=1===n.length&&1===n[0].fileType?q(n[0]):"ZIP",l=o>0?E(o):"Kh√¥ng r√µ",a=[`ƒê√£ ch·ªçn: ${n.length} (t·∫≠p tin: ${t}, th∆∞ m·ª•c: ${i})`,`ƒê·∫ßu ra: ${r}`,`Dung l∆∞·ª£ng ∆∞·ªõc t√≠nh: ${l}`];e.innerHTML=a.map(e=>`<div class="ilz-muted">${e}</div>`).join("")}function W(){!function(){const e=v(r);if(!e)return;const n=w.pathStack.map((e,n)=>`<span class="ilz-crumb" data-idx="${n}">${R(e.name||"G·ªëc")}</span>`);e.innerHTML=n.join('<span class="ilz-crumb-sep">/</span>')}(),V();const e=v(o),n=v(l);if(!e)return;if(w.loading)return e.innerHTML='<div class="ilz-empty">ƒêang t·∫£i...</div>',void(n&&(n.checked=!1));const t=Y();if("all"===w.searchScope&&!w.indexItems.length&&w.indexing)return e.innerHTML='<div class="ilz-empty">ƒêang l·∫≠p ch·ªâ m·ª•c...</div>',void(n&&(n.checked=!1));if("all"===w.searchScope&&!w.indexItems.length&&!w.indexing)return e.innerHTML='<div class="ilz-empty">H√£y l·∫≠p ch·ªâ m·ª•c ƒë·ªÉ t√¨m trong t·∫•t c·∫£ th∆∞ m·ª•c.</div>',void(n&&(n.checked=!1));if(!t.length)return e.innerHTML='<div class="ilz-empty">Kh√¥ng c√≥ m·ª•c n√†o.</div>',void(n&&(n.checked=!1));const i=t.map(e=>{const n=w.selectedKeys.has(e.key),t=q(e),i=1===e.fileType&&e.sizeBytes?E(e.sizeBytes):"-",o=2===e.fileType?'<button class="ilz-btn" data-action="download-zip">T·∫£i zip</button>':'<button class="ilz-btn" data-action="download-file">T·∫£i</button>';return`\n        <div class="ilz-row" data-key="${e.key}">\n          <div class="ilz-col ilz-col-check">\n            <input class="ilz-check" type="checkbox" data-action="toggle" ${n?"checked":""} />\n          </div>\n          <div class="ilz-col ilz-col-name" data-action="open" title="${e.path}">\n            ${2===e.fileType?"üìÅ":"üìÑ"} ${e.name}\n          </div>\n          <div class="ilz-col ilz-col-type">${t}</div>\n          <div class="ilz-col ilz-col-size">${i}</div>\n          <div class="ilz-col ilz-col-upd">${e.updTime||"-"}</div>\n          <div class="ilz-col ilz-col-actions">${o}</div>\n        </div>\n      `}).join("");e.innerHTML=i;const a=t.length>0&&t.every(e=>w.selectedKeys.has(e.key));n&&(n.checked=a)}async function X(){if(w.indexing)return;w.indexing=!0,w.indexItems=[],P("ƒêang l·∫≠p ch·ªâ m·ª•c to√†n b·ªô..."),U("");const e={files:0,folders:0},n=[];for(const t of w.rootItems){if(w.cancelRequested)break;const i=K(t,"");n.push(i),2===i.fileType?(e.folders+=1,await H(w.shareId,i.folderId,i.path,n,e)):e.files+=1,U(`ƒê√£ l·∫≠p ch·ªâ m·ª•c: ${e.files} t·∫≠p tin, ${e.folders} th∆∞ m·ª•c`)}w.indexItems=Z(n),w.indexing=!1,P("L·∫≠p ch·ªâ m·ª•c xong."),W()}async function ee(e){const n=[],t=new Set,i=new Set;for(const o of e){if(w.cancelRequested)break;if(2===o.fileType)await F(w.shareId,o.folderId,o.path,n,t,i);else{if(i.has(o.fileId))continue;const e=B(o.path,t);i.add(o.fileId),n.push({fileId:o.fileId,fileName:o.name,path:e,sizeBytes:o.sizeBytes})}}const o=n.reduce((e,n)=>e+(n.sizeBytes||0),0);return{files:n,totalBytes:o}}async function ne(e){w.downloading=!0,w.cancelRequested=!1,P(`ƒêang t·∫£i ${e.name}...`),U(""),G(e.sizeBytes||0);const n=S(e.fileId,w.shareId);let t=0;try{const i=await T(n,e=>{if(w.cancelRequested)return;const n=e.loaded||0,i=Math.max(0,n-t);t=n,w.transfer.downloadedBytes+=i;const o=e.total?` / ${E(e.total)}`:"";U(`${E(n)}${o}`),D()});if(w.cancelRequested)return;const o=new Blob([i]),r=R(e.name||`file_${e.fileId}`);L(o,r),P("Ho√†n t·∫•t."),U(`ƒê√£ l∆∞u ${r}`)}catch(e){P("L·ªói."),U(e&&e.message?e.message:String(e))}finally{w.downloading=!1}}async function te(e,n){P("ƒêang t·∫£i c√°c t·∫≠p tin..."),U(""),G(e.reduce((e,n)=>e+(n.sizeBytes||0),0));const t=new JSZip;for(let n=0;n<e.length;n+=1){if(w.cancelRequested)return;const i=e[n],o=S(i.fileId,w.shareId);let r=0;P(`ƒêang t·∫£i ${n+1}/${e.length}`);const l=await T(o,e=>{if(w.cancelRequested)return;const n=e.loaded||0,t=Math.max(0,n-r);r=n,w.transfer.downloadedBytes+=t;const o=e.total?` / ${E(e.total)}`:"";U(`${i.path} - ${E(n)}${o}`),D()});t.file(i.path,l,{binary:!0})}if(w.cancelRequested)return;P("ƒêang t·∫°o zip..."),U("C√≥ th·ªÉ m·∫•t th·ªùi gian n·∫øu th∆∞ m·ª•c l·ªõn.");L(await t.generateAsync({type:"blob"}),n),P("Ho√†n t·∫•t."),U(`ƒê√£ l∆∞u ${n}`)}async function ie(){if(w.downloading)return;const e=Array.from(w.selectedKeys).map(e=>w.itemStore.get(e)).filter(Boolean);if(e.length){w.downloading=!0,w.cancelRequested=!1;try{P("ƒêang chu·∫©n b·ªã l·ª±a ch·ªçn..."),U("");const{files:n,totalBytes:t}=await ee(e);if(w.cancelRequested)return;if(!n.length)return void P("Kh√¥ng t√¨m th·∫•y t·∫≠p tin.");if(function(e,n){return 1===e.length&&1===e[0].fileType&&1===n.length}(e,n))return void await ne(e[0]);const i=`${R(1===e.length?e[0].name:`share_${w.shareId}`)}.zip`;P(`Chu·∫©n b·ªã zip (∆∞·ªõc t√≠nh ${E(t)})...`),await te(n,i)}catch(e){P("L·ªói."),U(e&&e.message?e.message:String(e))}finally{w.downloading=!1}}else P("Ch∆∞a ch·ªçn g√¨.")}async function oe(){if(w.downloading)return;if(!w.currentFolderId)return w.selectedKeys=new Set(w.currentItems.map(e=>e.key)),V(),void await ie();const e=w.pathStack[w.pathStack.length-1].name||`share_${w.shareId}`,n={key:`d:${w.currentFolderId}`,name:R(e),path:O(),fileType:2,folderId:w.currentFolderId,fileId:null,sizeBytes:0};w.downloading=!0,w.cancelRequested=!1;try{P("ƒêang chu·∫©n b·ªã th∆∞ m·ª•c..."),U("");const{files:t}=await ee([n]);if(w.cancelRequested)return;if(!t.length)return void P("Kh√¥ng t√¨m th·∫•y t·∫≠p tin.");const i=`${R(e)}.zip`;await te(t,i)}catch(e){P("L·ªói."),U(e&&e.message?e.message:String(e))}finally{w.downloading=!1}}function re(e){const n=e.target.closest(".ilz-row");if(!n)return;const t=n.getAttribute("data-key"),i=w.itemStore.get(t);if(!i)return;const o=e.target.closest("[data-action]"),r=o?o.getAttribute("data-action"):"";if("toggle"===r){return void function(e,n){n?w.selectedKeys.add(e):w.selectedKeys.delete(e),V()}(t,o.checked)}if("download-file"!==r)return"download-zip"===r?(w.selectedKeys=new Set([i.key]),V(),void ie()):void("open"===r&&2===i.fileType&&"current"===w.searchScope&&async function(e){2===e.fileType&&(w.currentFolderId=e.folderId,w.pathStack=[...w.pathStack,{name:e.name,folderId:e.folderId}],await Q())}(i));ne(i)}function le(){if($&&v(t))return;let e=document.getElementById(n);if(e||(e=document.createElement("div"),e.id=n,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.zIndex="999999",document.body.appendChild(e)),$=e.shadowRoot||e.attachShadow({mode:"open"}),v(t))return;const b=document.createElement("style");b.textContent=`\n      :host {\n        font-family: Arial, sans-serif;\n        color: #111;\n      }\n      *, *::before, *::after {\n        box-sizing: border-box;\n      }\n      #${t} {\n        position: fixed;\n        right: 18px;\n        bottom: 18px;\n        z-index: 99999;\n        padding: 10px 14px;\n        border: none;\n        border-radius: 10px;\n        background: #0a7cff;\n        color: #fff;\n        font-size: 14px;\n        cursor: pointer;\n        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);\n        font-family: inherit;\n      }\n      #${i} {\n        position: fixed;\n        inset: 0;\n        z-index: 99998;\n        display: none;\n        align-items: center;\n        justify-content: center;\n        background: rgba(0, 0, 0, 0.45);\n        font-family: inherit;\n      }\n      #${i} .ilz-card {\n        width: 1200px;\n        max-width: 96vw;\n        max-height: 92vh;\n        background: #fff;\n        border-radius: 14px;\n        padding: 16px 18px;\n        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);\n        display: flex;\n        flex-direction: column;\n      }\n      #${i} .ilz-header {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n      #${i} .ilz-title {\n        font-size: 18px;\n        font-weight: 700;\n      }\n      #${i} .ilz-header-actions {\n        display: flex;\n        gap: 8px;\n        flex-wrap: wrap;\n        align-items: center;\n      }\n      #${i} .ilz-header-actions input,\n      #${i} .ilz-header-actions select,\n      #${i} button {\n        font-family: inherit;\n      }\n      #${i} .ilz-header-actions input,\n      #${i} .ilz-header-actions select {\n        padding: 6px 8px;\n        border-radius: 6px;\n        border: 1px solid #d0d0d0;\n      }\n      #${i} .ilz-main {\n        display: grid;\n        grid-template-columns: 1fr 300px;\n        gap: 16px;\n        margin-top: 12px;\n        overflow: hidden;\n        flex: 1;\n      }\n      #${i} .ilz-list {\n        border: 1px solid #e1e1e1;\n        border-radius: 10px;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n      }\n      #${i} .ilz-list-body {\n        overflow: auto;\n      }\n      #${i} .ilz-row {\n        display: grid;\n        grid-template-columns: 36px 1.6fr 100px 120px 160px 140px;\n        gap: 8px;\n        align-items: center;\n        padding: 8px 10px;\n        border-bottom: 1px solid #f0f0f0;\n      }\n      #${i} .ilz-row-head {\n        background: #f7f7f7;\n        font-weight: 600;\n      }\n      #${i} .ilz-col-name {\n        cursor: pointer;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      #${i} .ilz-col-actions {\n        display: flex;\n        gap: 6px;\n      }\n      #${i} .ilz-btn {\n        padding: 6px 8px;\n        border-radius: 6px;\n        border: 1px solid #d0d0d0;\n        background: #fafafa;\n        cursor: pointer;\n        font-size: 12px;\n      }\n      #${i} .ilz-sidebar {\n        border: 1px solid #e1e1e1;\n        border-radius: 10px;\n        padding: 12px;\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        overflow: auto;\n      }\n      #${i} .ilz-section-title {\n        font-weight: 600;\n        margin-bottom: 6px;\n      }\n      #${i} .ilz-muted {\n        font-size: 12px;\n        color: #444;\n      }\n      #${i} .ilz-empty {\n        padding: 20px;\n        color: #666;\n      }\n      #${i} .ilz-breadcrumbs {\n        font-size: 12px;\n        color: #333;\n      }\n      #${i} .ilz-crumb {\n        cursor: pointer;\n      }\n      #${i} .ilz-crumb-sep {\n        margin: 0 6px;\n        color: #888;\n      }\n      @media (max-width: 900px) {\n        #${t} {\n          right: 12px;\n          bottom: 12px;\n          padding: 8px 10px;\n          font-size: 12px;\n          border-radius: 8px;\n        }\n        #${i} {\n          align-items: stretch;\n          justify-content: stretch;\n          overflow: auto;\n        }\n        #${i} .ilz-card {\n          width: 100%;\n          max-width: 100vw;\n          max-height: 100vh;\n          height: 100%;\n          border-radius: 0;\n          padding: 12px;\n          overflow: auto;\n          -webkit-overflow-scrolling: touch;\n        }\n        #${i} .ilz-title {\n          font-size: 16px;\n        }\n        #${i} .ilz-header-actions {\n          flex-direction: column;\n          align-items: stretch;\n        }\n        #${i} .ilz-header-actions input,\n        #${i} .ilz-header-actions select,\n        #${i} .ilz-header-actions button {\n          width: 100%;\n        }\n        #${i} .ilz-main {\n          grid-template-columns: 1fr;\n          grid-template-rows: minmax(220px, 1fr) auto;\n          gap: 12px;\n          overflow: visible;\n          flex: 0 0 auto;\n        }\n        #${i} .ilz-list-body {\n          max-height: 55vh;\n        }\n        #${i} .ilz-row,\n        #${i} .ilz-row-head {\n          grid-template-columns: 28px 1fr 96px;\n          gap: 6px;\n          padding: 6px 8px;\n        }\n        #${i} .ilz-row-head .ilz-col:nth-child(3),\n        #${i} .ilz-row-head .ilz-col:nth-child(4),\n        #${i} .ilz-row-head .ilz-col:nth-child(5) {\n          display: none;\n        }\n        #${i} .ilz-row .ilz-col-type,\n        #${i} .ilz-row .ilz-col-size,\n        #${i} .ilz-row .ilz-col-upd {\n          display: none;\n        }\n        #${i} .ilz-col-actions {\n          justify-content: flex-end;\n        }\n        #${i} .ilz-col-actions .ilz-btn {\n          padding: 6px;\n          font-size: 11px;\n        }\n        #${i} .ilz-btn {\n          font-size: 12px;\n        }\n        #${i} .ilz-sidebar {\n          padding: 10px;\n        }\n        #${i} .ilz-breadcrumbs {\n          word-break: break-all;\n        }\n      }\n      @media (max-width: 600px) {\n        #${i} .ilz-row,\n        #${i} .ilz-row-head {\n          grid-template-columns: 26px 1fr 86px;\n        }\n        #${i} .ilz-btn {\n          padding: 6px;\n        }\n      }\n    `,$.appendChild(b);const I=document.createElement("button");I.id=t,I.type="button",I.textContent="M·ªü tr√¨nh qu·∫£n l√Ω",I.addEventListener("click",async()=>{const e=v(i);e&&(e.style.display="flex"),w.cancelRequested=!1,await J(),W()}),$.appendChild(I);const k=document.createElement("div");k.id=i,k.innerHTML=`\n      <div class="ilz-card">\n        <div class="ilz-header">\n          <div class="ilz-title">Tr√¨nh qu·∫£n l√Ω iLanZou</div>\n          <div class="ilz-header-actions">\n            <input id="${a}" type="text" placeholder="T√¨m ki·∫øm" />\n            <select id="${s}">\n              <option value="current">Th∆∞ m·ª•c hi·ªán t·∫°i</option>\n              <option value="all">T·∫•t c·∫£ th∆∞ m·ª•c</option>\n            </select>\n            <button id="${c}" class="ilz-btn">L·∫≠p ch·ªâ m·ª•c to√†n b·ªô</button>\n            <button id="${d}" class="ilz-btn">L√†m m·ªõi</button>\n            <button id="${u}" class="ilz-btn">ƒê√≥ng</button>\n          </div>\n          <div id="${r}" class="ilz-breadcrumbs"></div>\n        </div>\n        <div class="ilz-main">\n          <div class="ilz-list">\n            <div class="ilz-row ilz-row-head">\n              <div class="ilz-col ilz-col-check">\n                <input id="${l}" type="checkbox" />\n              </div>\n              <div class="ilz-col">T√™n</div>\n              <div class="ilz-col">Lo·∫°i</div>\n              <div class="ilz-col">Dung l∆∞·ª£ng</div>\n              <div class="ilz-col">C·∫≠p nh·∫≠t</div>\n              <div class="ilz-col">Thao t√°c</div>\n            </div>\n            <div id="${o}" class="ilz-list-body"></div>\n          </div>\n          <div class="ilz-sidebar">\n            <div>\n              <div class="ilz-section-title">L·ª±a ch·ªçn</div>\n              <div id="${y}"></div>\n              <button id="${x}" class="ilz-btn">T·∫£i m·ª•c ƒë√£ ch·ªçn</button>\n              <button id="${z}" class="ilz-btn">T·∫£i th∆∞ m·ª•c hi·ªán t·∫°i</button>\n            </div>\n            <div>\n              <div class="ilz-section-title">Tr·∫°ng th√°i</div>\n              <div id="${f}" class="ilz-muted">S·∫µn s√†ng</div>\n              <div id="${p}" class="ilz-muted"></div>\n              <div id="${h}" class="ilz-muted"></div>\n              <div id="${m}" class="ilz-muted"></div>\n              <button id="${g}" class="ilz-btn">H·ªßy</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,$.appendChild(k);const S=v(o);S&&S.addEventListener("click",re),k.addEventListener("click",e=>{const n=e.target.closest(".ilz-crumb");if(!n)return;const t=Number(n.getAttribute("data-idx"));Number.isFinite(t)&&async function(e){if(e<0||e>=w.pathStack.length)return;const n=w.pathStack[e];w.pathStack=w.pathStack.slice(0,e+1),w.currentFolderId=n.folderId,await Q()}(t)});const T=v(a);T&&T.addEventListener("input",e=>{w.searchQuery=e.target.value||"",W()});const L=v(s);L&&L.addEventListener("change",e=>{w.searchScope=e.target.value||"current",W()});const R=v(c);R&&R.addEventListener("click",X);const B=v(d);B&&B.addEventListener("click",Q);const C=v(l);C&&C.addEventListener("change",e=>{var n;n=e.target.checked,Y().forEach(e=>{n?w.selectedKeys.add(e.key):w.selectedKeys.delete(e.key)}),W()});const E=v(x);E&&E.addEventListener("click",ie);const q=v(z);q&&q.addEventListener("click",oe);const M=v(g);M&&M.addEventListener("click",()=>{w.cancelRequested=!0,w.currentRequest&&w.currentRequest.abort(),P("ƒê√£ h·ªßy.")});const K=v(u);K&&K.addEventListener("click",()=>{w.downloading||(k.style.display="none")})}const ae=setInterval(()=>{document.body&&(clearInterval(ae),w.shareId=function(){const e=location.pathname.split("/").filter(Boolean);return e.length>=2?e[1]:""}(),le())},300)}();

