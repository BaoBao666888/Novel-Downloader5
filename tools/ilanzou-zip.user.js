// ==UserScript==
// @name         Tr√¨nh qu·∫£n l√Ω Cloud
// @namespace    local.ilanzou.zip
// @version      0.3.1
// @description  Duy·ªát share iLanZou/Lanzov, t√¨m ki·∫øm, t·∫£i file l·∫ª ho·∫∑c zip theo l·ª±a ch·ªçn.
// @icon         data:image/png;base64,AAABAAEAICAAAAEAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/FRwD/xkkB/8RFEP/CPxr/wDoc/741HP+8MBz/uiwc/7gmHP+2IRz/tBwc/7IZHP+yGBz/shgc/7IYHP+yGBz/shgc/7IYHP+yGBz/sxkc/K8VHPuvFxz+tB8c/7cmHP+5LRn/ujIJ/7E+AP+4NAAAAAAAAAAAAAAAAAD/y1MA/8xVE//IT2//xkrA/8RE3//CP+P/wDnj/7404/+8MOP/uivj/7gm4/+2IOP/sxzj/7IZ4/+yGOP/shjj/7IY4/+yGOP/shjj/rEX4/yvFOP9rxXj/bIa4/+1IeP/tynk/7ow2v+8N6f/vz9O/8BGCP/AQwAAAAAA/9BhAP/RYxb/zlyl/8tW+v/JUf//x03//8VH///DQv//wT3//784//+9M///uy7//7kp//+3JP//tR///7Mb//+yGP//shj//7IY//2vFf/8rRD//a8S//+yGP//tSD//7cn//+5Lv//vDX//748///AQ+//wkp8/8VQCf/ETQD/2YAC/9RqfP/SZf3/z2D//81b///LVv//yVH//8dM///FR///w0L//8E9//+/OP//vTL//7st//+5Kf//tiP//7Uf//+zGv/8rhL//KwM//+vEf//shj//7Qf//+3Jv//uS3//7w0//++O///wEL//8JJ///EUPL/x1Vd/7tIAP/aeB//13PS/9Vv///Tav//0WT//89f///NWv//y1X//8lQ///HS///xUb//8NB///BPP//vzf//7wy//+7Lf/+uCf/+68V//2sCv//rw///7IX//+0Hf//tiX//7ks//+7M/7/vTn//8BA///CSP//xU///8dW///JXLz/ymET/9uAQ//bfez/2Xj//9dz///Vbv//02n//9Fk///PX///zVr//8tV///JUP//x0v//8VG///CQf//wTz//742//uzH//8rAn//68O//+xFv//tB3//7Yj//+4Kv//uzH//704/v+/QP//wUf//8RO///GVf//yVz//8ti6f/MZjr/3ohB/9+G6//dgv//233//9l3///Xcv//1W7//9Np///QY///zl7//81Z///LVP//yE///8ZK///FRv/7uS3//KwM//+uDf//sRT+/7Qb//+2I///uCn//7ow//+9N///vz7+/8JF/v/DTf//xlP//8ha///LYv//zWju/81rSf/ijyP/4o/X/+GL///fhv//3YH//9p8///Yd///13L//9Vt///SaP//0GP//85e///NWf//y1X//MJE//quE///rgz//7ET//+zGv//tSH//7go//+6L///vDb//749///BRP//w0v//8ZS///IWf//ymD+/8xn///Pbuf/0HE2/+OTBP/ll4f/5ZT//+OP///hiv//3oX//9yA///ae///2Hb//9Zx///UbP//02f//9Fi//7NW//5tij//awL//+wEv//shn//7Qg//+3J///uS7//7w1/v++PP//wUP//8NK///FUf//yFj+/8pf///MZv//zm7//9Bzvf/SdRP/6J0A/+idG//onK//5pn9/+SU///ij///4Ir//96F///cgP//2nv//9h2///Wcf//1W3/+sVO//qtEf//sBD//7IY//+0H///tib//7kt//+7NP//vjv//8BC///CSf//xVD//8dX///JXv//zGX//85s///Qc/D/0XZY/853AP/xrAD/6J4A/+mhGf/pn37/6JzW/+aZ/f/kk///4o7//+CJ///ehP//3H///9p7//7Wc//4uDH//q4O//+yF///tB7//7Yl//+5LP//uzP//706///AQf//wkj//8RP///HVv//yV3//8tk///Oa///0HLu/9F2e//TeQj/0ngAAAAAAAAAAAD/7KEA//GeAf/qoz//6qLs/+id///mmP//5JP//+KO///gif//3oX/+9Bp//iuGf//sRX//7Qd//+2JP//uCv//7sy//+9Of//v0D//8JH///ETv//x1T+/8lc///LYvD/zWnT/89vo//RdEj/0XsH/9F4AAAAAAAAAAAAAAAAAAAAAAD/7akA/+2pEP/tqLz/7Kb//+qi///onP//5Zf//+ST//7gi//2vkT//K8U//+zHP//tiP//7gq//+7MP//vTf//78+///BRv//w03//8ZU///JW///y2L9/81me//PbRP/0XEI/9ZvAP/NcQAAAAAAAAAAAAAAAAAAAAAAAAAAAP/sqwD/7qoA/+2qTP/tquL/7an//+ul///qof/+5pn/98xk//evG///shr//7Ui//+4KP//ujD//702/v+/Pf//wUT//8NM///GUv//yFr//8pg///NZ/T/zWtP/81qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/rqgD/6asC/+2pQf/tqaH/7arG/+ymv/fIWtr3rx3//rIY//+1IP//tyf//7ku//+8Nf//vjz//8FD///DSv//xVL//8hY///KX///zGb//85s2P/OcCP/zm8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAO/NYwAAAAAA/euiB//vrRL97rEO+64RaP+yF/j/tB///7cm//+5Lf//vDT+/747/v/AQv//wkn//8VQ///HV///yV7//8xl///ObP//0HCO/89zBP/PcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+zGQD/shYT/7Qesf+2Jf//uSz//7sz//++Ov//wEH//8JI///FT/7/x1b+/8ld/v/MZP//zmv//9BxzP/RdCb/0HMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/70gAP+3JwD/tyUu/7grxP+6Mv//vTn//79A///CR///xE7//8dV///JXP//y2P//85q///PcNj/0XNF/89vAP/SdQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/7svAP+0QAD/uTAk/7w3l/+/Puv/wUb+/8RN///GVP//yFv//8ti///NafP/z26w/9ByNP/ShgH/0HUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+/PgD/vzwJ/8BDPP/DS4P/xVKr/8hZvP/KX7D/zGWO/85rTv/Pbw//zmwA/890AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/y1MA/9FSAf/GVQn/yVwP/8tiC//LZgL/ymUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////////////////////////4AAAB8AAAAOAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAcAAAAHgAAAD8AAAD/gAAD/4AAA//AAAP//AAH//4AD///AA///4A////g////////////////////////////8=
// @match        https://www.ilanzou.com/s/*
// @match        https://lanzov.com/*
// @match        https://*.lanzov.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_download
// @grant        GM_cookie
// @connect      api.ilanzou.com
// @connect      *
// @downloadURL  https://raw.githubusercontent.com/BaoBao666888/Novel-Downloader5/main/tools/ilanzou-zip.user.js
// @updateURL    https://raw.githubusercontent.com/BaoBao666888/Novel-Downloader5/main/tools/ilanzou-zip.user.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js
// @require      https://unpkg.com/fflate@0.8.2/umd/index.js
// ==/UserScript==
!function(){"use strict";const e="https://api.ilanzou.com",n="lanzov",t="ilz-shadow-host",i="ilz-manager-btn",r="ilz-manager-panel",o="ilz-list-body",a="ilz-breadcrumbs",s="ilz-select-all",l="ilz-search",c="ilz-scope",d="ilz-index",u="ilz-refresh",f="ilz-close",h="ilz-status",p="ilz-progress",m="ilz-speed",g="ilz-eta",w="ilz-cancel",y="ilz-selection-info",z="ilz-download-selected",x="ilz-download-folder";const v=function(){const e=location.hostname||"";return/(^|\.)ilanzou\.com$/i.test(e)?"ilanzou":/(^|\.)lanzov\.com$/i.test(e)?n:""}();let $=null;const b={provider:v,shareId:"",shareCode:"",shareInfo:null,shareTitle:"",rootItems:[],currentFolderId:null,pathStack:[{name:"G·ªëc",folderId:null}],currentItems:[],itemStore:new Map,selectedKeys:new Set,searchQuery:"",searchScope:"current",indexItems:[],indexing:!1,loading:!1,downloading:!1,cancelRequested:!1,currentRequest:null,downloadCache:new Map,cookieJar:new Map,debugLogs:[],lanzov:{fid:"",uid:"",t:"",k:"",pwd:""},transfer:{startTime:0,totalBytes:0,downloadedBytes:0}},I="1"===localStorage.getItem("ilz_debug")||/(?:^|[?&])ilz_debug=1(?:&|$)/.test(location.search)||/(?:^|#)ilz_debug=1(?:&|$)/.test(location.hash);function k(...e){if(I){try{const n=e.map(e=>"string"==typeof e?e:JSON.stringify(e)).join(" ");b.debugLogs.push({ts:(new Date).toISOString(),message:n}),b.debugLogs.length>200&&b.debugLogs.shift()}catch(e){}console.log("[ILZ]",...e)}}function T(e){return $?$.getElementById(e):null}function L(e){const n=CryptoJS.enc.Utf8.parse("lanZouY-disk-app");return CryptoJS.AES.encrypt(e,n,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString().toUpperCase()}function S(){let e=localStorage.getItem("uuid");return e||(e=crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,e=>{const n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)}),localStorage.setItem("uuid",e)),e}function E(e,n,t){const i=!t||void 0===t.withCredentials||t.withCredentials;return new Promise((t,r)=>{GM_xmlhttpRequest({method:"GET",url:e,headers:n||{},withCredentials:i,onload:e=>t(e.responseText||""),onerror:()=>r(new Error("L·ªói m·∫°ng")),ontimeout:()=>r(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}function R(e,n,t){const i=!t||void 0===t.withCredentials||t.withCredentials;return new Promise((t,r)=>{GM_xmlhttpRequest({method:"GET",url:e,headers:n||{},withCredentials:i,onload:e=>t({text:e.responseText||"",headers:e.responseHeaders||""}),onerror:()=>r(new Error("L·ªói m·∫°ng")),ontimeout:()=>r(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}function _(e,n,t,i){const r=new URLSearchParams;Object.keys(n||{}).forEach(e=>{const t=n[e];null!=t&&r.set(e,String(t))});const o=!i||void 0===i.withCredentials||i.withCredentials;return new Promise((n,i)=>{GM_xmlhttpRequest({method:"POST",url:e,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json, text/plain, */*",...t||{}},data:r.toString(),withCredentials:o,onload:t=>{const r=t.responseText||"";try{const e=JSON.parse(r);n(e)}catch(n){k("gmPostForm JSON parse fail",e,r.slice(0,200)),i(new Error("Ph·∫£n h·ªìi JSON kh√¥ng h·ª£p l·ªá"))}},onerror:()=>i(new Error("L·ªói m·∫°ng")),ontimeout:()=>i(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}async function C(n,t){const i=function(n,t){const i={devType:6,devModel:"Chrome",uuid:S(),extra:2,timestamp:L(String(Date.now())),...t},r=new URLSearchParams;return Object.keys(i).forEach(e=>{const n=i[e];null!=n&&""!==n&&r.set(e,String(n))}),`${e}${n}?${r.toString()}`}(n,t),r=await function(e){return new Promise((n,t)=>{GM_xmlhttpRequest({method:"POST",url:e,headers:{Accept:"application/json, text/plain, */*"},onload:e=>{try{const t=JSON.parse(e.responseText);n(t)}catch(e){t(new Error("Ph·∫£n h·ªìi JSON kh√¥ng h·ª£p l·ªá"))}},onerror:()=>t(new Error("L·ªói m·∫°ng")),ontimeout:()=>t(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}(i);if(!r||200!==r.code)throw new Error(r&&r.msg||"API error");return r}async function M(e,n,t){if("function"!=typeof fetch)return _(e,n,t);const i=new URLSearchParams;Object.keys(n||{}).forEach(e=>{const t=n[e];null!=t&&i.set(e,String(t))});const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Accept:"application/json, text/plain, */*",...t||{}},body:i.toString(),credentials:"include"}),o=await r.text();try{return JSON.parse(o)}catch(n){throw k("fetchFormJson JSON parse fail",e,o.slice(0,200)),new Error("Ph·∫£n h·ªìi JSON kh√¥ng h·ª£p l·ªá")}}function q(n,t){const i=Date.now(),r=L(`${n}|`),o=L(`${n}|${i}`),a=new URLSearchParams({downloadId:r,enable:1,devType:6,uuid:S(),timestamp:L(String(i)),auth:o,shareId:t});return`${e}/unproved/file/redirect?${a.toString()}`}async function B(e){return b.provider===n?async function(e){const n=e.fileId||e.key,t=b.downloadCache.get(n);if(t&&Date.now()-t.ts<3e5)return t;const i=location.origin;if(!e.fileId)throw new Error("Thi·∫øu ID t·∫≠p tin");const r=e.fileId.startsWith("http")?e.fileId:`${i}/${e.fileId}`,o=e.name||e.fileName||`file_${e.fileId}`;k("Lanzov start",{name:o,fileId:e.fileId,fileUrl:r}),ve(`ƒêang l·∫•y link ${o}...`),$e("");const a=await E(r,{Referer:location.href}),s=e=>{if(!e)return"";const n=e.match(/var\s+fid\s*=\s*['"]?(\d+)/i);if(n)return n[1];const t=e.match(/\/q\/jb\/\?f=(\d+)/i);if(t)return t[1];const i=e.match(/ajaxm\.php\?file=(\d+)/i);return i?i[1]:""},l=a.match(/<iframe[^>]+src=["']([^"']+)["']/i),c=s(a);if(k("Lanzov file page",{fid:c,hasIframe:Boolean(l)}),!l)throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin t·∫£i");const d=new URL(l[1],i).href,u=await E(d,{Referer:r}),f=c||s(u)||"";if(!f)throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin t·∫£i");const h=u.match(/var\s+ajaxdata\s*=\s*'([^']+)'/),p=u.match(/var\s+wp_sign\s*=\s*'([^']+)'/),m=u.match(/var\s+kdns\s*=\s*(\d+)/),g=u.match(/var\s+down_3\s*=\s*'([^']*)'/),w=h?h[1]:"",y=p?p[1]:"",z=m?m[1]:"1",x=g?g[1]:"&toolsdown";if(k("Lanzov fn vars",{ajaxDataLen:w.length,wpSignLen:y.length,kdns:z,down3:x}),!w||!y)throw new Error("Thi·∫øu token t·∫£i");const v=await _(`${i}/ajaxm.php?file=${f}`,{action:"downprocess",websignkey:w,signs:w,sign:y,websign:"",kd:z,ves:1},{Referer:d,"X-Requested-With":"XMLHttpRequest"});if(k("Lanzov ajaxm",v),!v||1!==v.zt||!v.url||!v.dom)throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c link trung gian");const $=String(v.dom).replace(/\\\//g,"/").replace(/\/$/,""),I=v.url.startsWith("?")?v.url:`?${v.url}`,T=`${$}/file/${I}${x||""}`,L=new URL($).origin===location.origin;k("Lanzov tools",{dom:$,toolsUrl:T,sameOrigin:L});const S=new URL($).hostname,C=await R(T,{Referer:d});J(S,C.headers),await ee(S,C.headers),await V(S);const q=F(S);q.has("down_ip")||q.set("down_ip","1");await Q("down_ip","1",S);let B=C.text,A=me(B,"file"),j=me(B,"sign"),U=pe(B),G="";if(!U){k("Lanzov acw missing, retry buffer");const e=await function(e,n,t){const i=!t||void 0===t.withCredentials||t.withCredentials;return new Promise((t,r)=>{GM_xmlhttpRequest({method:"GET",url:e,headers:n||{},responseType:"arraybuffer",withCredentials:i,onload:e=>t({buffer:e.response,headers:e.responseHeaders||""}),onerror:()=>r(new Error("L·ªói m·∫°ng")),ontimeout:()=>r(new Error("H·∫øt th·ªùi gian y√™u c·∫ßu"))})})}(T,{Referer:d}),n=function(e,n){if(!e)return"";const t=e instanceof Uint8Array?e:new Uint8Array(e);if(!t.length)return"";let i=t;if((n||"").toLowerCase().includes("content-encoding: gzip")||t.length>2&&31===t[0]&&139===t[1])try{const e=P();e&&"function"==typeof e.gunzipSync&&(i=e.gunzipSync(t))}catch(e){k("gunzip fail",e&&e.message)}if("undefined"!=typeof TextDecoder)return new TextDecoder("utf-8").decode(i);try{const e=P();if(e&&"function"==typeof e.strFromU8)return e.strFromU8(i)}catch(e){}return""}(e.buffer,e.headers);n&&(B=n),U=pe(B)}if(U){q.set("acw_sc__v2",U),await Q("acw_sc__v2",U,S),k("Lanzov acw cookie",{hasAcw:!0});const e=ne(S),n=await R(T,{Referer:d,Cookie:e});if(J(S,n.headers),await ee(S,n.headers),await V(S),G=ne(S),B=n.text,A=me(B,"file"),j=me(B,"sign"),!A||!j)throw k("Lanzov tools params missing after acw",B.slice(0,200)),new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c tham s·ªë t·∫£i");A=ge(A),j=ge(j),k("Lanzov tools params",{fileLen:A.length,signLen:j.length})}else if(A&&j)k("Lanzov tools params from first"),A=ge(A),j=ge(j),k("Lanzov tools params",{fileLen:A.length,signLen:j.length});else{k("Lanzov acw still missing",B.slice(0,200)),await ie(T),await te(1e3);const e=await R(T,{Referer:d});if(J(S,e.headers),await ee(S,e.headers),await V(S),B=e.text,A=me(B,"file"),j=me(B,"sign"),!A||!j)throw k("Lanzov tools params missing after warmup",B.slice(0,200)),new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c cookie t·∫£i");A=ge(A),j=ge(j),k("Lanzov tools params",{fileLen:A.length,signLen:j.length})}G||(G=ne(S));const H=/acw_sc__v2=/.test(G||""),N=/acw_tc=/.test(G||""),O=/cdn_sec_tc=/.test(G||"");L||H&&N&&O||(k("Lanzov pre-warmup (no acw)"),await ie(T),await te(800),await V(S),G=ne(S),k("Lanzov cookie header warmup",{len:G.length}));k("Lanzov cookie header",{len:G.length,hasAcw:H,hasAcwTc:N,hasCdnTc:O});const K=async(e,n,t)=>{const i=[2,1,3];for(const r of i){let i=null;const o=null===t&&L;if(null!==t||L||k("Lanzov skip fetch (cross-origin)",{dom:$}),o)try{k("Lanzov file/ajax fetch",{el:r}),i=await M(`${$}/file/ajax.php`,{file:e,el:r,sign:n},{Referer:T,Origin:$})}catch(e){k("Lanzov file/ajax fetch error",{el:r,message:e&&e.message}),i=null}if(i||(k("Lanzov file/ajax gm",{el:r,cookieMode:null===t?"browser":t?"header":"none"}),i=await _(`${$}/file/ajax.php`,{file:e,el:r,sign:n},{Referer:T,Origin:$,"X-Requested-With":"XMLHttpRequest",...t?{Cookie:t}:{}},{withCredentials:!0})),k("Lanzov file/ajax resp",{el:r,zt:i&&i.zt,url:i&&i.url?String(i.url).slice(0,120):""}),!i||1!==i.zt||!i.url)continue;const a=String(i.url).replace(/\\\//g,"/");if(!/signerror/i.test(a))return a}return""},D=G,X=L?Z?null:D:D||"";let W=await K(A,j,X);if(!W){k("Lanzov warmup toolsdown"),await ie(T),await te(1e3);const e=await R(T,{Referer:d});J(S,e.headers),await ee(S,e.headers),await V(S);let n=me(e.text,"file"),t=me(e.text,"sign");if(n&&t){n=ge(n),t=ge(t);const e=ne(S),i=L?Z?null:e:e||"";W=await K(n,t,i)}}if(!W)throw k("Lanzov SignError"),new Error("Link t·∫£i h·∫øt h·∫°n (SignError)");k("Lanzov finalUrl",{url:String(W).slice(0,120)});const Y={url:W,referer:`${$}/`};return b.downloadCache.set(n,{...Y,ts:Date.now()}),Y}(e):{url:q(e.fileId,b.shareId),referer:"https://www.ilanzou.com/"}}function A(e,n,t){return new Promise((i,r)=>{k("Download start",{url:e}),b.currentRequest=GM_xmlhttpRequest({method:"GET",url:e,headers:{Referer:"https://www.ilanzou.com/",...t||{}},responseType:"arraybuffer",onprogress:e=>{n&&n(e)},onload:n=>{b.currentRequest=null;n.status>=200&&n.status<400||0===n.status&&n.response?i(n.response):(k("Download HTTP",{status:n.status,url:e}),r(new Error(`HTTP ${n.status}`)))},onerror:()=>{b.currentRequest=null,k("Download error",{url:e}),r(new Error("T·∫£i th·∫•t b·∫°i"))},ontimeout:()=>{b.currentRequest=null,k("Download timeout",{url:e}),r(new Error("H·∫øt th·ªùi gian t·∫£i"))}})})}async function j(e,n,t,i){let r=null;const o=Math.max(1,i||1);for(let i=1;i<=o;i+=1)try{return await A(e,n,t)}catch(e){r=e,k("Download retry",{attempt:i,maxTry:o,message:e&&e.message}),i<o&&await te(800)}throw r||new Error("T·∫£i th·∫•t b·∫°i")}function P(){if("undefined"!=typeof fflate)return fflate;if("undefined"!=typeof window&&window.fflate)return window.fflate;throw new Error("Thi·∫øu th∆∞ vi·ªán fflate")}function U(e,n){const t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=n,document.body.appendChild(t),t.click(),t.remove(),URL.revokeObjectURL(t.href)}function G(e,n,t,i){return W?new Promise((r,o)=>{GM_download({url:e,name:n,headers:t||{},onprogress:e=>{i&&i(e)},onload:()=>r(!0),onerror:e=>{const n=e&&e.error?String(e.error):"T·∫£i th·∫•t b·∫°i";o(new Error(n))},ontimeout:()=>o(new Error("H·∫øt th·ªùi gian t·∫£i"))})}):Promise.reject(new Error("GM_download kh√¥ng kh·∫£ d·ª•ng"))}function H(e){return e?String(e).replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"unnamed"}function N(e,n){if(!n.has(e))return n.add(e),e;const t=e.lastIndexOf("."),i=t>0?e.slice(0,t):e,r=t>0?e.slice(t):"";let o=1,a=`${i} (${o})${r}`;for(;n.has(a);)o+=1,a=`${i} (${o})${r}`;return n.add(a),a}function O(e){const n=Number(e);return!Number.isFinite(n)||n<=0?0:Math.round(1024*n)}function K(e){if(!e)return 0;const n=String(e).trim().match(/([\d.]+)\s*([KMG]?)/i);if(!n)return 0;const t=Number(n[1]);if(!Number.isFinite(t)||t<=0)return 0;const i=(n[2]||"").toUpperCase();return"G"===i?Math.round(1024*t*1024*1024):"M"===i?Math.round(1024*t*1024):"K"===i?Math.round(1024*t):Math.round(t)}function F(e){return b.cookieJar.has(e)||b.cookieJar.set(e,new Map),b.cookieJar.get(e)}function D(e){if(!e)return[];const n=[],t=String(e).split(/\r?\n/);for(const e of t){if(!e)continue;if(0!==e.toLowerCase().indexOf("set-cookie:"))continue;const t=e.slice(11).trim();if(!t)continue;const i=t.split(";")[0],r=i.indexOf("=");if(r<=0)continue;const o=i.slice(0,r).trim(),a=i.slice(r+1).trim();o&&n.push({name:o,value:a})}return n}function J(e,n){const t=D(n);if(!t.length)return t;const i=F(e);return t.forEach(({name:e,value:n})=>{i.set(e,n)}),t}const Z="undefined"!=typeof GM_cookie&&GM_cookie&&"function"==typeof GM_cookie.set,X=Z&&"function"==typeof GM_cookie.list,W="function"==typeof GM_download;function Q(e,n,t){return Z?new Promise(i=>{try{GM_cookie.set({name:e,value:n,domain:t,path:"/"},e=>i(Boolean(e)))}catch(e){i(!1)}}):Promise.resolve(!1)}function Y(e){return X?new Promise(n=>{try{GM_cookie.list({domain:e},e=>n(e||[]))}catch(e){n([])}}):Promise.resolve([])}async function V(e){if(!X)return;const n=[];e&&n.push(e);const t=function(e){if(!e)return"";const n=String(e).split(".").filter(Boolean);return n.length<=2?n.join("."):n.slice(-2).join(".")}(e);t&&t!==e&&n.push(t);const i=[];for(const e of n){const n=await Y(e);n&&n.length&&i.push(...n)}if(!i.length)return;const r=F(e);i.forEach(e=>{e&&e.name&&r.set(e.name,e.value||"")})}async function ee(e,n){if(!Z)return;const t=D(n);for(const n of t)await Q(n.name,n.value,e)}function ne(e,n){const t=F(e),i=new Map(t);return n&&Object.keys(n).forEach(e=>{const t=n[e];null!=t&&i.set(e,String(t))}),Array.from(i.entries()).map(([e,n])=>`${e}=${n}`).join("; ")}function te(e){return new Promise(n=>setTimeout(n,e))}function ie(e){return new Promise(n=>{const t=document.createElement("iframe");t.style.display="none",t.width="0",t.height="0",t.src=e;let i=!1;const r=()=>{i||(i=!0,t.remove(),n())};t.onload=()=>{setTimeout(r,1500)},setTimeout(r,5e3),document.body.appendChild(t)})}function re(e){if(!e&&0!==e)return"";const n=["B","KB","MB","GB"];let t=e,i=0;for(;t>=1024&&i<n.length-1;)t/=1024,i+=1;return`${t.toFixed(1)} ${n[i]}`}function oe(e){if(2===e.fileType)return"Th∆∞ m·ª•c";const n=function(e){const n=e.lastIndexOf(".");return n<0?"":e.slice(n+1).toLowerCase()}(e.name||"");return n?n.toUpperCase():"T·∫≠p tin"}function ae(e){return 2===e.fileType||e.isFolder?`d:${e.folderId}`:`f:${e.fileId}`}function se(e,n){const t=2===e.fileType,i=H(e.folderName||e.fileName||e.name||(t?"folder":"file")),r=t?`${n}${i}/`:`${n}${i}`,o={key:ae(e),name:i,path:r,fileType:t?2:1,fileId:e.fileId||null,folderId:e.folderId||null,sizeBytes:O(e.fileSize),sizeRaw:e.fileSize||0,updTime:e.updTime||""};return b.itemStore.set(o.key,o),o}function le(e,n){const t=H((i=e.name_all||e.name||"file")?String(i).replace(/<[^>]*>/g,"").trim():"");var i;const r=`${n}${t}`,o={key:`f:${e.id}`,name:t,path:r,fileType:1,fileId:e.id||null,folderId:null,sizeBytes:K(e.size),sizeRaw:e.size||"",updTime:e.time||""};return b.itemStore.set(o.key,o),o}function ce(e){const n=e.match(/filemoreajax\.php\?file=(\d+)/);function t(n){if(!n)return"";const t=new RegExp(`(?:var|let|const)?\\s*${i=n,i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\s*=\\s*['"]?([A-Za-z0-9]+)`,"i");var i;const r=e.match(t);return r?r[1]:""}function i(n){const i=new RegExp(`['"]${n}['"]\\s*:\\s*['"]?([A-Za-z0-9]+)`,"i"),r=e.match(i);if(r){const e=r[1],n=t(e);return n&&n!==e?n:e}const o=new RegExp(`['"]${n}['"]\\s*:\\s*([A-Za-z0-9_$]+)`,"i"),a=e.match(o);return a?t(a[1]):""}const r=i("uid"),o=i("t"),a=i("k")||t("_gw52i"),s=e.match(/document\.title\s*=\s*'([^']+)'/i)||e.match(/<title>([^<]+)<\/title>/i);return{fid:n?n[1]:"",uid:r||"",t:o||"",k:a||"",title:s?s[1].trim():""}}function de(){const e=document.cookie||"";["save_ck","codelen","pc_ad1"].forEach(n=>{e.includes(`${n}=`)||(document.cookie=`${n}=1; path=/`)})}async function ue(e){de();let n="";e||(n=document.documentElement?document.documentElement.outerHTML:"");let t=n?ce(n):{fid:"",uid:"",t:"",k:"",title:""};if(t.fid&&t.uid&&t.t&&t.k||(n=await async function(e,n){return"function"!=typeof fetch?E(e,n):(await fetch(e,{method:"GET",headers:n||{},credentials:"include"})).text()}(location.href,{Referer:location.href}),t=ce(n)),!(t.fid&&t.uid&&t.t&&t.k))throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin chia s·∫ª");b.lanzov.fid=t.fid,b.lanzov.uid=t.uid,b.lanzov.t=t.t,b.lanzov.k=t.k,t.title&&(b.shareTitle=t.title)}async function fe(e,n){de();return M(`${location.origin}/filemoreajax.php?file=${b.lanzov.fid}`,{lx:2,fid:b.lanzov.fid,uid:b.lanzov.uid,pg:e,rep:0,t:b.lanzov.t,k:b.lanzov.k,up:1,ls:1,pwd:n||""},{Referer:location.href,Origin:location.origin,"X-Requested-With":"XMLHttpRequest"})}async function he(){let e=b.lanzov.pwd;if(!e){const n=sessionStorage.getItem(`lanzov_pwd_${b.shareId}`);n&&(e=n)}let n=0;for(;;){const t=await fe(1,e||"");if(3===t.zt||6===t.zt){const n=t.info||"M√£ sai",i=(window.prompt(`${n}. Nh·∫≠p l·∫°i m√£:`,e||"")||"").trim();if(!i)throw new Error("ƒê√£ h·ªßy");e=i,b.lanzov.pwd=e;continue}if(2===t.zt)return[];if(1!==t.zt){if(n<1){n+=1,await ue(!0);continue}throw new Error(t.info||"Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch")}const i=Array.isArray(t.text)?t.text.slice():[];let r=2;for(;Array.isArray(t.text)&&t.text.length>=50;){let t=await fe(r,e||"");if(1!==t.zt&&n<1&&(n+=1,await ue(!0),t=await fe(r,e||"")),1!==t.zt)break;if(Array.isArray(t.text)&&i.push(...t.text),!t.text||t.text.length<50)break;r+=1}return e&&(sessionStorage.setItem(`lanzov_pwd_${b.shareId}`,e),b.lanzov.pwd=e),i}}function pe(e){if(!e)return"";const n=[],t=/<script[^>]*>([\s\S]*?)<\/script>/gi;let i=t.exec(e);for(;i;){const r=(i[1]||"").trim();r&&n.push(r),i=t.exec(e)}if(!n.length)return"";const r=n.filter(e=>/acw_sc__v2|arg1\s*=|document\.cookie/.test(e)),o=r.length?r:n;for(const e of o){const n={cookie:"",location:{reload:()=>{}}},t={document:n,location:n.location},i={userAgent:"undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent:""};try{const r=new Function("document","window","navigator",`${e}; return document.cookie;`),o=r(n,t,i)||n.cookie||"",a=/acw_sc__v2=([^;]+)/.exec(o);if(a)return a[1]}catch(e){}}return""}function me(e,n){const t=new RegExp(`'${n}'\\s*:\\s*'([^']+)'`),i=e.match(t);return i?i[1]:""}function ge(e){if(!e||"string"!=typeof e)return e;if(!/%[0-9A-Fa-f]{2}/.test(e))return e;try{return decodeURIComponent(e)}catch(n){return e}}async function we(e,n){return C("/unproved/recommend/list",{shareId:e,code:n,userId:"",type:0,offset:1,limit:60})}async function ye(e,n,t){return C("/unproved/share/list",{shareId:e,folderId:n||null,offset:t,limit:60})}async function ze(e,n,t,i,r,o,a){let s=1,l=1;for(;s<=l;){if(b.cancelRequested)return;const c=await ye(e,n,s);l=c.totalPage||1;const d=Array.isArray(c.list)?c.list:[];for(const n of d){if(b.cancelRequested)return;if(2===n.fileType){const s=H(n.folderName||n.name||"folder");await ze(e,n.folderId,`${t}${s}/`,i,r,o,a)}else if(1===n.fileType){if(o.has(n.fileId))continue;const e=H(n.fileName||n.name||"file"),s=N(`${t}${e}`,r);o.add(n.fileId),i.push({fileId:n.fileId,fileName:e,path:s,sizeBytes:O(n.fileSize)}),a&&a()}}s+=1}}async function xe(e,n,t,i,r){let o=1,a=1;for(;o<=a;){if(b.cancelRequested)return;const s=await ye(e,n,o);a=s.totalPage||1;const l=Array.isArray(s.list)?s.list:[];for(const n of l){if(b.cancelRequested)return;const o=se(n,t);i.push(o),2===o.fileType?(r.folders+=1,await xe(e,o.folderId,o.path,i,r)):r.files+=1}o+=1}}function ve(e){const n=T(h);n&&(n.textContent=e||"")}function $e(e){const n=T(p);n&&(n.textContent=e||"")}function be(e){const n=T(m);n&&(n.textContent=e||"")}function Ie(e){const n=T(g);n&&(n.textContent=e||"")}function ke(){const e=(Date.now()-b.transfer.startTime)/1e3;if(e<=0)return;const n=b.transfer.downloadedBytes/e,t=n?`${re(n)}/s`:"";if(be(t?`T·ªëc ƒë·ªô: ${t}`:""),b.transfer.totalBytes>0&&n>0){Ie(`C√≤n l·∫°i: ${function(e){if(!Number.isFinite(e)||e<=0)return"";let n=Math.round(e);const t=Math.floor(n/3600);n-=3600*t;const i=Math.floor(n/60);n-=60*i;const r=[];return t&&r.push(`${t}h`),i&&r.push(`${i}m`),r.push(`${n}s`),r.join(" ")}(Math.max(0,b.transfer.totalBytes-b.transfer.downloadedBytes)/n)}`)}else Ie("")}function Te(e){b.transfer.startTime=Date.now(),b.transfer.totalBytes=e||0,b.transfer.downloadedBytes=0,be(""),Ie("")}function Le(){if(b.pathStack.length<=1)return"";const e=b.pathStack.slice(1).map(e=>H(e.name));return e.length?`${e.join("/")}/`:""}async function Se(){if(!b.shareInfo){b.loading=!0,ve("ƒêang t·∫£i chia s·∫ª...");try{if(b.provider===n){await ue();const e=await he();b.shareInfo={list:e},b.rootItems=e.filter(e=>e&&e.id&&"-1"!==e.id&&1!==e.t),b.currentFolderId=null,b.pathStack=[{name:"G·ªëc",folderId:null}];const n=Le();return b.currentItems=Ee(b.rootItems.map(e=>le(e,n))),b.loading=!1,void Me()}if(b.shareInfo=await async function(){let e=new URLSearchParams(location.search).get("code")||"";if(!e){const n=sessionStorage.getItem(`ilz_code_${b.shareId}`);n&&(e=n)}for(e&&(b.shareCode=e);;){const n=await we(b.shareId,e);if(1===n.status||2===n.status){const t=2===n.status?"M√£ sai. Nh·∫≠p l·∫°i:":"C·∫ßn m√£ truy c·∫≠p. Nh·∫≠p m√£:";if(e=(window.prompt(t,e||"")||"").trim(),!e)throw new Error("ƒê√£ h·ªßy");b.shareCode=e,sessionStorage.setItem(`ilz_code_${b.shareId}`,e);continue}if(!n.list||!n.list.length)throw new Error("Kh√¥ng t√¨m th·∫•y n·ªôi dung chia s·∫ª");return b.shareCode=e||"",n.list[0]}}(),b.rootItems=Array.isArray(b.shareInfo.fileList)?b.shareInfo.fileList:[],1===b.rootItems.length&&2===b.rootItems[0].fileType){const e=b.rootItems[0];b.pathStack=[{name:"G·ªëc",folderId:null},{name:e.folderName||e.name||"Th∆∞ m·ª•c",folderId:e.folderId}],b.currentFolderId=e.folderId,await Re()}else b.currentFolderId=null,b.pathStack=[{name:"G·ªëc",folderId:null}],await Re()}finally{b.loading=!1}}}function Ee(e){return e.slice().sort((e,n)=>e.fileType!==n.fileType?2===e.fileType?-1:1:(e.name||"").localeCompare(n.name||""))}async function Re(){b.loading=!0,Me();const e=Le();if(b.provider===n){try{await ue();const n=await he();b.rootItems=n.filter(e=>e&&e.id&&"-1"!==e.id&&1!==e.t),b.currentItems=Ee(b.rootItems.map(n=>le(n,e)))}finally{b.loading=!1,Me()}return}if(!b.currentFolderId)return b.currentItems=b.rootItems.map(n=>se(n,e)),b.currentItems=Ee(b.currentItems),b.loading=!1,void Me();const t=await async function(e,n){let t=1,i=1;const r=[];for(;t<=i;){if(b.cancelRequested)return r;const o=await ye(e,n,t);i=o.totalPage||1,r.push(...o.list||[]),t+=1}return r}(b.shareId,b.currentFolderId);b.currentItems=Ee(t.map(n=>se(n,e))),b.loading=!1,Me()}function _e(){const e=b.searchQuery.trim().toLowerCase();let t=[];return t="all"===b.searchScope?b.provider===n?b.currentItems:b.indexItems:b.currentItems,e?t.filter(n=>n.path.toLowerCase().includes(e)):t}function Ce(){const e=T(y);if(!e)return;const n=Array.from(b.selectedKeys).map(e=>b.itemStore.get(e)).filter(Boolean),t=n.filter(e=>1===e.fileType).length,i=n.filter(e=>2===e.fileType).length,r=n.filter(e=>1===e.fileType).reduce((e,n)=>e+(n.sizeBytes||0),0),o=1===n.length&&1===n[0].fileType?oe(n[0]):"ZIP",a=r>0?re(r):"Kh√¥ng r√µ",s=[`ƒê√£ ch·ªçn: ${n.length} (t·∫≠p tin: ${t}, th∆∞ m·ª•c: ${i})`,`ƒê·∫ßu ra: ${o}`,`Dung l∆∞·ª£ng ∆∞·ªõc t√≠nh: ${a}`];e.innerHTML=s.map(e=>`<div class="ilz-muted">${e}</div>`).join("")}function Me(){!function(){const e=T(a);if(!e)return;const n=b.pathStack.map((e,n)=>`<span class="ilz-crumb" data-idx="${n}">${H(e.name||"G·ªëc")}</span>`);e.innerHTML=n.join('<span class="ilz-crumb-sep">/</span>')}(),Ce();const e=T(o),t=T(s);if(!e)return;if(b.loading)return e.innerHTML='<div class="ilz-empty">ƒêang t·∫£i...</div>',void(t&&(t.checked=!1));const i=_e();if("all"===b.searchScope&&b.provider!==n&&!b.indexItems.length&&b.indexing)return e.innerHTML='<div class="ilz-empty">ƒêang l·∫≠p ch·ªâ m·ª•c...</div>',void(t&&(t.checked=!1));if("all"===b.searchScope&&b.provider!==n&&!b.indexItems.length&&!b.indexing)return e.innerHTML='<div class="ilz-empty">H√£y l·∫≠p ch·ªâ m·ª•c ƒë·ªÉ t√¨m trong t·∫•t c·∫£ th∆∞ m·ª•c.</div>',void(t&&(t.checked=!1));if(!i.length)return e.innerHTML='<div class="ilz-empty">Kh√¥ng c√≥ m·ª•c n√†o.</div>',void(t&&(t.checked=!1));const r=i.map(e=>{const n=b.selectedKeys.has(e.key),t=oe(e),i=1===e.fileType&&e.sizeBytes?re(e.sizeBytes):"-",r=2===e.fileType?'<button class="ilz-btn" data-action="download-zip">T·∫£i zip</button>':'<button class="ilz-btn" data-action="download-file">T·∫£i</button>';return`\n        <div class="ilz-row" data-key="${e.key}">\n          <div class="ilz-col ilz-col-check">\n            <input class="ilz-check" type="checkbox" data-action="toggle" ${n?"checked":""} />\n          </div>\n          <div class="ilz-col ilz-col-name" data-action="open" title="${e.path}">\n            ${2===e.fileType?"üìÅ":"üìÑ"} ${e.name}\n          </div>\n          <div class="ilz-col ilz-col-type">${t}</div>\n          <div class="ilz-col ilz-col-size">${i}</div>\n          <div class="ilz-col ilz-col-upd">${e.updTime||"-"}</div>\n          <div class="ilz-col ilz-col-actions">${r}</div>\n        </div>\n      `}).join("");e.innerHTML=r;const l=i.length>0&&i.every(e=>b.selectedKeys.has(e.key));t&&(t.checked=l)}async function qe(){if(b.indexing)return;if(b.indexing=!0,b.indexItems=[],ve("ƒêang l·∫≠p ch·ªâ m·ª•c to√†n b·ªô..."),$e(""),b.provider===n)return b.indexItems=Ee(b.currentItems.slice()),b.indexing=!1,ve("L·∫≠p ch·ªâ m·ª•c xong."),void Me();const e={files:0,folders:0},t=[];for(const n of b.rootItems){if(b.cancelRequested)break;const i=se(n,"");t.push(i),2===i.fileType?(e.folders+=1,await xe(b.shareId,i.folderId,i.path,t,e)):e.files+=1,$e(`ƒê√£ l·∫≠p ch·ªâ m·ª•c: ${e.files} t·∫≠p tin, ${e.folders} th∆∞ m·ª•c`)}b.indexItems=Ee(t),b.indexing=!1,ve("L·∫≠p ch·ªâ m·ª•c xong."),Me()}async function Be(e){const n=[],t=new Set,i=new Set;for(const r of e){if(b.cancelRequested)break;if(2===r.fileType)await ze(b.shareId,r.folderId,r.path,n,t,i);else{if(i.has(r.fileId))continue;const e=N(r.path,t);i.add(r.fileId),n.push({fileId:r.fileId,fileName:r.name,path:e,sizeBytes:r.sizeBytes})}}const r=n.reduce((e,n)=>e+(n.sizeBytes||0),0);return{files:n,totalBytes:r}}async function Ae(e,t){if(b.downloading&&(!t||!t.force))return ve("ƒêang t·∫£i, ƒë·ª£i x√≠u..."),void $e("");b.downloading=!0,b.cancelRequested=!1,ve(`ƒêang t·∫£i ${e.name}...`),$e(""),Te(e.sizeBytes||0);const i=await B(e);ve(`ƒêang t·∫£i ${e.name}...`),$e("");const r=i.url,o=i.referer?{Referer:i.referer}:null,a=H(e.name||`file_${e.fileId}`);let s=0;try{if(b.provider===n&&W){if(await G(r,a,o||void 0,e=>{if(b.cancelRequested)return;const n=e.loaded||0,t=Math.max(0,n-s);s=n,b.transfer.downloadedBytes+=t;const i=e.total?` / ${re(e.total)}`:"";$e(`${re(n)}${i}`),ke()}),b.cancelRequested)return;ve("Ho√†n t·∫•t."),$e(`ƒê√£ l∆∞u ${a}`)}else{const e=await j(r,e=>{if(b.cancelRequested)return;const n=e.loaded||0,t=Math.max(0,n-s);s=n,b.transfer.downloadedBytes+=t;const i=e.total?` / ${re(e.total)}`:"";$e(`${re(n)}${i}`),ke()},o||void 0,2);if(b.cancelRequested)return;U(new Blob([e]),a),ve("Ho√†n t·∫•t."),$e(`ƒê√£ l∆∞u ${a}`)}}catch(e){k("Download failed",{url:r,message:e&&e.message}),ve("L·ªói."),$e(e&&e.message?e.message:String(e)),r&&b.provider!==n&&(!function(e,n){const t=document.createElement("a");t.href=e,n&&(t.download=n),t.target="_blank",t.rel="noopener",document.body.appendChild(t),t.click(),t.remove()}(r,a),ve("ƒê√£ m·ªü link tr·ª±c ti·∫øp."),$e("Tr√¨nh duy·ªát s·∫Ω t·ª± t·∫£i n·∫øu kh√¥ng b·ªã ch·∫∑n popup."))}finally{b.downloading=!1}}async function je(e,n){ve("ƒêang t·∫£i c√°c t·∫≠p tin..."),$e(""),Te(e.reduce((e,n)=>e+(n.sizeBytes||0),0));const t={};for(let n=0;n<e.length;n+=1){if(b.cancelRequested)return;const i=e[n],r=await B(i),o=r.url,a=r.referer?{Referer:r.referer}:null;let s,l=0;ve(`ƒêang t·∫£i ${n+1}/${e.length}`);try{s=await j(o,e=>{if(b.cancelRequested)return;const n=e.loaded||0,t=Math.max(0,n-l);l=n,b.transfer.downloadedBytes+=t;const r=e.total?` / ${re(e.total)}`:"";$e(`${i.path} - ${re(n)}${r}`),ke()},a||void 0,2)}catch(e){const n=e&&e.message?e.message:String(e);throw new Error(`T·∫£i th·∫•t b·∫°i: ${i.path} (${n})`)}t[i.path]=new Uint8Array(s)}if(b.cancelRequested)return;ve("ƒêang t·∫°o zip..."),$e("ƒêang n√©n...");const i=await function(e){return new Promise((n,t)=>{const i=P();i&&"function"==typeof i.zip?i.zip(e,{level:0},(e,i)=>{e?t(e):n(i)}):t(new Error("Thi·∫øu h√†m zip c·ªßa fflate"))})}(t);if(b.cancelRequested)return;U(new Blob([i],{type:"application/zip"}),n),ve("Ho√†n t·∫•t."),$e(`ƒê√£ l∆∞u ${n}`)}async function Pe(e){if(!W)throw new Error("Tr√¨nh qu·∫£n l√Ω kh√¥ng h·ªó tr·ª£ t·∫£i nhi·ªÅu file Lanzov (thi·∫øu GM_download).");ve("ƒêang t·∫£i c√°c t·∫≠p tin (Lanzov)..."),$e(""),Te(e.reduce((e,n)=>e+(n.sizeBytes||0),0));for(let n=0;n<e.length;n+=1){if(b.cancelRequested)return;const t=e[n],i=await B(t),r=i.url,o=i.referer?{Referer:i.referer}:null,a=H(t.fileName||t.name||`file_${t.fileId}`);let s=0;ve(`ƒêang t·∫£i ${n+1}/${e.length}`);try{await G(r,a,o||void 0,e=>{if(b.cancelRequested)return;const n=e.loaded||0,i=Math.max(0,n-s);s=n,b.transfer.downloadedBytes+=i;const r=e.total?` / ${re(e.total)}`:"";$e(`${t.path||a} - ${re(n)}${r}`),ke()})}catch(e){const n=e&&e.message?e.message:String(e);throw new Error(`T·∫£i th·∫•t b·∫°i: ${t.path||a} (${n})`)}}ve("Ho√†n t·∫•t."),$e(`ƒê√£ l∆∞u ${e.length} t·∫≠p tin`)}async function Ue(){if(b.downloading)return;const e=Array.from(b.selectedKeys).map(e=>b.itemStore.get(e)).filter(Boolean);if(e.length){b.downloading=!0,b.cancelRequested=!1;try{ve("ƒêang chu·∫©n b·ªã l·ª±a ch·ªçn..."),$e("");const{files:t,totalBytes:i}=await Be(e);if(b.cancelRequested)return;if(!t.length)return void ve("Kh√¥ng t√¨m th·∫•y t·∫≠p tin.");if(function(e,n){return 1===e.length&&1===e[0].fileType&&1===n.length}(e,t))return void await Ae(e[0],{force:!0});if(b.provider===n)return ve("Lanzov kh√¥ng h·ªó tr·ª£ zip, ƒëang t·∫£i t·ª´ng file..."),void await Pe(t);const r=`${H(1===e.length?e[0].name:b.provider===n&&b.shareTitle?b.shareTitle:`share_${b.shareId}`)}.zip`;ve(`Chu·∫©n b·ªã zip (∆∞·ªõc t√≠nh ${re(i)})...`),await je(t,r)}catch(e){ve("L·ªói."),$e(e&&e.message?e.message:String(e))}finally{b.downloading=!1}}else ve("Ch∆∞a ch·ªçn g√¨.")}async function Ge(){if(b.downloading)return;if(!b.currentFolderId)return b.selectedKeys=new Set(b.currentItems.map(e=>e.key)),Ce(),void await Ue();const e=b.pathStack[b.pathStack.length-1].name||`share_${b.shareId}`,t={key:`d:${b.currentFolderId}`,name:H(e),path:Le(),fileType:2,folderId:b.currentFolderId,fileId:null,sizeBytes:0};b.downloading=!0,b.cancelRequested=!1;try{ve("ƒêang chu·∫©n b·ªã th∆∞ m·ª•c..."),$e("");const{files:i}=await Be([t]);if(b.cancelRequested)return;if(!i.length)return void ve("Kh√¥ng t√¨m th·∫•y t·∫≠p tin.");if(b.provider===n)ve("Lanzov kh√¥ng h·ªó tr·ª£ zip, ƒëang t·∫£i t·ª´ng file..."),await Pe(i);else{const n=`${H(e)}.zip`;await je(i,n)}}catch(e){ve("L·ªói."),$e(e&&e.message?e.message:String(e))}finally{b.downloading=!1}}function He(e){const n=e.target.closest(".ilz-row");if(!n)return;const t=n.getAttribute("data-key"),i=b.itemStore.get(t);if(!i)return;const r=e.target.closest("[data-action]"),o=r?r.getAttribute("data-action"):"";if("toggle"===o){return void function(e,n){n?b.selectedKeys.add(e):b.selectedKeys.delete(e),Ce()}(t,r.checked)}if("download-file"!==o)return"download-zip"===o?(b.selectedKeys=new Set([i.key]),Ce(),void Ue()):void("open"===o&&2===i.fileType&&"current"===b.searchScope&&async function(e){2===e.fileType&&(b.currentFolderId=e.folderId,b.pathStack=[...b.pathStack,{name:e.name,folderId:e.folderId}],await Re())}(i));Ae(i)}function Ne(){if($&&T(i))return;let e=document.getElementById(t);if(e||(e=document.createElement("div"),e.id=t,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.zIndex="999999",document.body.appendChild(e)),$=e.shadowRoot||e.attachShadow({mode:"open"}),T(i))return;const v=document.createElement("style");v.textContent=`\n      :host {\n        font-family: Arial, sans-serif;\n        color: #111;\n      }\n      *, *::before, *::after {\n        box-sizing: border-box;\n      }\n      #${i} {\n        position: fixed;\n        right: 18px;\n        bottom: 18px;\n        z-index: 99999;\n        padding: 10px 14px;\n        border: none;\n        border-radius: 10px;\n        background: #0a7cff;\n        color: #fff;\n        font-size: 14px;\n        cursor: pointer;\n        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);\n        font-family: inherit;\n      }\n      #${r} {\n        position: fixed;\n        inset: 0;\n        z-index: 99998;\n        display: none;\n        align-items: center;\n        justify-content: center;\n        background: rgba(0, 0, 0, 0.45);\n        font-family: inherit;\n      }\n      #${r} .ilz-card {\n        width: 1200px;\n        max-width: 96vw;\n        max-height: 92vh;\n        background: #fff;\n        border-radius: 14px;\n        padding: 16px 18px;\n        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);\n        display: flex;\n        flex-direction: column;\n      }\n      #${r} .ilz-header {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n      #${r} .ilz-title {\n        font-size: 18px;\n        font-weight: 700;\n      }\n      #${r} .ilz-header-actions {\n        display: flex;\n        gap: 8px;\n        flex-wrap: wrap;\n        align-items: center;\n      }\n      #${r} .ilz-header-actions input,\n      #${r} .ilz-header-actions select,\n      #${r} button {\n        font-family: inherit;\n      }\n      #${r} .ilz-header-actions input,\n      #${r} .ilz-header-actions select {\n        padding: 6px 8px;\n        border-radius: 6px;\n        border: 1px solid #d0d0d0;\n      }\n      #${r} .ilz-main {\n        display: grid;\n        grid-template-columns: 1fr 300px;\n        gap: 16px;\n        margin-top: 12px;\n        overflow: hidden;\n        flex: 1;\n      }\n      #${r} .ilz-list {\n        border: 1px solid #e1e1e1;\n        border-radius: 10px;\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n      }\n      #${r} .ilz-list-body {\n        overflow: auto;\n      }\n      #${r} .ilz-row {\n        display: grid;\n        grid-template-columns: 36px 1.6fr 100px 120px 160px 140px;\n        gap: 8px;\n        align-items: center;\n        padding: 8px 10px;\n        border-bottom: 1px solid #f0f0f0;\n      }\n      #${r} .ilz-row-head {\n        background: #f7f7f7;\n        font-weight: 600;\n      }\n      #${r} .ilz-col-name {\n        cursor: pointer;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      #${r} .ilz-col-actions {\n        display: flex;\n        gap: 6px;\n      }\n      #${r} .ilz-btn {\n        padding: 6px 8px;\n        border-radius: 6px;\n        border: 1px solid #d0d0d0;\n        background: #fafafa;\n        cursor: pointer;\n        font-size: 12px;\n      }\n      #${r} .ilz-sidebar {\n        border: 1px solid #e1e1e1;\n        border-radius: 10px;\n        padding: 12px;\n        display: flex;\n        flex-direction: column;\n        gap: 12px;\n        overflow: auto;\n      }\n      #${r} .ilz-section-title {\n        font-weight: 600;\n        margin-bottom: 6px;\n      }\n      #${r} .ilz-muted {\n        font-size: 12px;\n        color: #444;\n      }\n      #${r} .ilz-empty {\n        padding: 20px;\n        color: #666;\n      }\n      #${r} .ilz-breadcrumbs {\n        font-size: 12px;\n        color: #333;\n      }\n      #${r} .ilz-crumb {\n        cursor: pointer;\n      }\n      #${r} .ilz-crumb-sep {\n        margin: 0 6px;\n        color: #888;\n      }\n      @media (max-width: 900px) {\n        #${i} {\n          right: 12px;\n          bottom: 12px;\n          padding: 8px 10px;\n          font-size: 12px;\n          border-radius: 8px;\n        }\n        #${r} {\n          align-items: stretch;\n          justify-content: stretch;\n          overflow: auto;\n        }\n        #${r} .ilz-card {\n          width: 100%;\n          max-width: 100vw;\n          max-height: 100vh;\n          height: 100%;\n          border-radius: 0;\n          padding: 12px;\n          overflow: auto;\n          -webkit-overflow-scrolling: touch;\n        }\n        #${r} .ilz-title {\n          font-size: 16px;\n        }\n        #${r} .ilz-header-actions {\n          flex-direction: column;\n          align-items: stretch;\n        }\n        #${r} .ilz-header-actions input,\n        #${r} .ilz-header-actions select,\n        #${r} .ilz-header-actions button {\n          width: 100%;\n        }\n        #${r} .ilz-main {\n          grid-template-columns: 1fr;\n          grid-template-rows: minmax(220px, 1fr) auto;\n          gap: 12px;\n          overflow: visible;\n          flex: 0 0 auto;\n        }\n        #${r} .ilz-list-body {\n          max-height: 55vh;\n        }\n        #${r} .ilz-row,\n        #${r} .ilz-row-head {\n          grid-template-columns: 28px 1fr 96px;\n          gap: 6px;\n          padding: 6px 8px;\n        }\n        #${r} .ilz-row-head .ilz-col:nth-child(3),\n        #${r} .ilz-row-head .ilz-col:nth-child(4),\n        #${r} .ilz-row-head .ilz-col:nth-child(5) {\n          display: none;\n        }\n        #${r} .ilz-row .ilz-col-type,\n        #${r} .ilz-row .ilz-col-size,\n        #${r} .ilz-row .ilz-col-upd {\n          display: none;\n        }\n        #${r} .ilz-col-actions {\n          justify-content: flex-end;\n        }\n        #${r} .ilz-col-actions .ilz-btn {\n          padding: 6px;\n          font-size: 11px;\n        }\n        #${r} .ilz-btn {\n          font-size: 12px;\n        }\n        #${r} .ilz-sidebar {\n          padding: 10px;\n        }\n        #${r} .ilz-breadcrumbs {\n          word-break: break-all;\n        }\n      }\n      @media (max-width: 600px) {\n        #${r} .ilz-row,\n        #${r} .ilz-row-head {\n          grid-template-columns: 26px 1fr 86px;\n        }\n        #${r} .ilz-btn {\n          padding: 6px;\n        }\n      }\n    `,$.appendChild(v);const I=b.provider===n?"Tr√¨nh qu·∫£n l√Ω Lanzou":"Tr√¨nh qu·∫£n l√Ω iLanZou",k=document.createElement("button");k.id=i,k.type="button",k.textContent="M·ªü tr√¨nh qu·∫£n l√Ω",k.addEventListener("click",async()=>{const e=T(r);e&&(e.style.display="flex"),b.cancelRequested=!1;try{await Se(),Me()}catch(e){ve("L·ªói."),$e(e&&e.message?e.message:String(e)),b.loading=!1,Me()}}),$.appendChild(k);const L=document.createElement("div");L.id=r,L.innerHTML=`\n      <div class="ilz-card">\n        <div class="ilz-header">\n          <div class="ilz-title">${I}</div>\n          <div class="ilz-header-actions">\n            <input id="${l}" type="text" placeholder="T√¨m ki·∫øm" />\n            <select id="${c}">\n              <option value="current">Th∆∞ m·ª•c hi·ªán t·∫°i</option>\n              <option value="all">T·∫•t c·∫£ th∆∞ m·ª•c</option>\n            </select>\n            <button id="${d}" class="ilz-btn">L·∫≠p ch·ªâ m·ª•c to√†n b·ªô</button>\n            <button id="${u}" class="ilz-btn">L√†m m·ªõi</button>\n            <button id="${f}" class="ilz-btn">ƒê√≥ng</button>\n          </div>\n          <div id="${a}" class="ilz-breadcrumbs"></div>\n        </div>\n        <div class="ilz-main">\n          <div class="ilz-list">\n            <div class="ilz-row ilz-row-head">\n              <div class="ilz-col ilz-col-check">\n                <input id="${s}" type="checkbox" />\n              </div>\n              <div class="ilz-col">T√™n</div>\n              <div class="ilz-col">Lo·∫°i</div>\n              <div class="ilz-col">Dung l∆∞·ª£ng</div>\n              <div class="ilz-col">C·∫≠p nh·∫≠t</div>\n              <div class="ilz-col">Thao t√°c</div>\n            </div>\n            <div id="${o}" class="ilz-list-body"></div>\n          </div>\n          <div class="ilz-sidebar">\n            <div>\n              <div class="ilz-section-title">L·ª±a ch·ªçn</div>\n              <div id="${y}"></div>\n              <button id="${z}" class="ilz-btn">T·∫£i m·ª•c ƒë√£ ch·ªçn</button>\n              <button id="${x}" class="ilz-btn">T·∫£i th∆∞ m·ª•c hi·ªán t·∫°i</button>\n            </div>\n            <div>\n              <div class="ilz-section-title">Tr·∫°ng th√°i</div>\n              <div id="${h}" class="ilz-muted">S·∫µn s√†ng</div>\n              <div id="${p}" class="ilz-muted"></div>\n              <div id="${m}" class="ilz-muted"></div>\n              <div id="${g}" class="ilz-muted"></div>\n              <button id="${w}" class="ilz-btn">H·ªßy</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,$.appendChild(L);const S=T(o);S&&S.addEventListener("click",He),L.addEventListener("click",e=>{const n=e.target.closest(".ilz-crumb");if(!n)return;const t=Number(n.getAttribute("data-idx"));Number.isFinite(t)&&async function(e){if(e<0||e>=b.pathStack.length)return;const n=b.pathStack[e];b.pathStack=b.pathStack.slice(0,e+1),b.currentFolderId=n.folderId,await Re()}(t)});const E=T(l);E&&E.addEventListener("input",e=>{b.searchQuery=e.target.value||"",Me()});const R=T(c);R&&R.addEventListener("change",e=>{b.searchScope=e.target.value||"current",Me()});const _=T(d);_&&_.addEventListener("click",qe);const C=T(u);C&&C.addEventListener("click",Re);const M=T(s);M&&M.addEventListener("change",e=>{var n;n=e.target.checked,_e().forEach(e=>{n?b.selectedKeys.add(e.key):b.selectedKeys.delete(e.key)}),Me()});const q=T(z);q&&q.addEventListener("click",Ue);const B=T(x);B&&B.addEventListener("click",Ge);const A=T(w);A&&A.addEventListener("click",()=>{b.cancelRequested=!0,b.currentRequest&&b.currentRequest.abort(),ve("ƒê√£ h·ªßy.")});const j=T(f);j&&j.addEventListener("click",()=>{b.downloading||(L.style.display="none")})}const Oe=setInterval(()=>{document.body&&(clearInterval(Oe),b.shareId=function(){const e=location.pathname.split("/").filter(Boolean);return b.provider===n?e.length>=1?e[0]:"":e.length>=2?e[1]:""}(),Ne())},300)}();